# 客戶頁面規格

> **版本**：3.0
> **日期**：2026-02-13

## CustomersPage `/customers`

- 資料表格：名稱、站區、類型、合約摘要、結算方式、狀態、操作（停用 or 啟用 / 刪除）
- 篩選：站區下拉、類型篩選、名稱搜尋
- 狀態篩選器：啟用中（預設）/ 已停用 / 全部
- 客戶名稱為超連結，點擊導航到 `/customers/:id` 詳情頁
- 「新增客戶」按鈕 → 導航到 `/customers/new`
- 停用 → Popconfirm「確定停用此客戶？停用後可重新啟用。」→ `PATCH deactivate`（`StopOutlined` warning 色）
- 啟用 → 已停用項目顯示「啟用」按鈕（`CheckCircleOutlined` 綠色）→ `PATCH reactivate` 恢復 active
- 刪除 → Popconfirm「確定刪除此客戶？此操作無法復原。」→ `DELETE` 硬刪除（`DeleteOutlined` danger 色）
- **不使用 Modal 編輯**，所有編輯在詳情頁完成

## CustomerDetailPage `/customers/:id`

### Tab 架構

**Tab 架構**，5 個分頁：

| Tab | 內容 | 說明 |
|-----|------|------|
| 基本資料 | 客戶所有設定欄位（inline 表單） | 可直接編輯並儲存（可編輯角色） |
| 合約管理 | 該客戶的合約列表 + 新增/編輯/終止合約 + 合約品項（刪除） | customerId 自動帶入 |
| 附加費用 | 費用列表 + 新增/編輯/停用/啟用 | 從原 CustomersPage Modal 獨立出來 |
| 車趟紀錄 | 該客戶的車趟歷史（唯讀） | 支援月份篩選 |
| 結算明細 | 該客戶的月結/按趟明細（唯讀） | 支援月份篩選 |

### 行為規則

- 各 Tab 懶載入：切換到該 Tab 時才發請求
- `/customers/new`：新增模式，只顯示基本資料 Tab
- 「返回列表」按鈕導航回 `/customers`
- `site_staff` 角色：表單 disabled，無儲存按鈕

## CustomerContractsTab（合約管理 Tab）

- 合約列表：合約編號、起訖日期、狀態、操作（編輯 / 終止）
- 終止 → Popconfirm「確定終止此合約？終止後無法恢復。」（`CloseCircleOutlined` danger 色）
- 合約品項操作：刪除 → Popconfirm「確定刪除此品項？此操作無法復原。」（`DeleteOutlined` danger 色，硬刪除）

## CustomerFeesTab（附加費用 Tab）

- 費用列表：費用名稱、金額、狀態、操作（編輯 / 停用 or 啟用 / 刪除）
- 停用 → Popconfirm「確定停用此附加費用？停用後可重新啟用。」→ `PATCH deactivate`（`StopOutlined` warning 色）
- 啟用 → 已停用項目顯示「啟用」按鈕（`CheckCircleOutlined` 綠色）→ `PATCH reactivate` 恢復 active
- 刪除 → Popconfirm「確定刪除此附加費用？此操作無法復原。」→ `DELETE` 硬刪除（`DeleteOutlined` danger 色）

## ContractsPage `/contracts`（合約總覽，僅 super_admin 可見）

- 資料表格：合約編號、客戶、起訖日期、狀態、操作（終止）
- 終止 → Popconfirm「確定終止此合約？終止後無法恢復。」（`CloseCircleOutlined` danger 色）
- 篩選：客戶下拉、狀態篩選
- 客戶名稱為超連結，導航到 `/customers/:id?tab=contracts`
- 供系統管理員跨客戶檢視所有合約（如篩選即將到期合約）

## 各 Tab Loading 狀態

| Tab | Loading 行為 |
|-----|-------------|
| 基本資料 | 表單骨架屏（標籤 + 輸入框灰塊） |
| 合約管理 | 表格骨架屏（5 行） |
| 附加費用 | 表格骨架屏（5 行） |
| 車趟紀錄 | 表格骨架屏（5 行）+ 篩選列正常顯示 |
| 結算明細 | 表格骨架屏（5 行）+ 篩選列正常顯示 |

- 切換 Tab 時觸發該 Tab 的 API 請求（懶載入）
- 已載入的 Tab 切換回來時使用快取，不重新請求（除非資料已過期）

## 表單驗證規則

### 客戶基本資料表單

| 欄位 | 規則 | 錯誤訊息 |
|------|------|---------|
| 名稱 | 必填、最長 100 字 | 「請輸入客戶名稱」/「名稱不得超過 100 字」 |
| 站區 | 必填 | 「請選擇所屬站區」 |
| 結算方式 | 必填 | 「請選擇結算方式」 |
| 通知方式 | 必填 | 「請選擇通知方式」 |
| 通知 Email | 通知方式含 email 時必填、Email 格式 | 「請輸入通知 Email」/「Email 格式不正確」 |
| 行號 | 選填 | — |

### 合約表單

| 欄位 | 規則 | 錯誤訊息 |
|------|------|---------|
| 開始日期 | 必填 | 「請選擇合約開始日期」 |
| 結束日期 | 必填、≥ 開始日期 | 「請選擇合約結束日期」/「結束日期不得早於開始日期」 |
| 合約品項 | 至少一項 | 「請至少新增一個合約品項」 |
| 品項單價 | 必填、≥ 0 | 「請輸入單價」/「單價不得為負數」 |
| 品項方向 | 必填 | 「請選擇計費方向」 |

### 附加費用表單

| 欄位 | 規則 | 錯誤訊息 |
|------|------|---------|
| 費用名稱 | 必填、最長 50 字 | 「請輸入費用名稱」/「名稱不得超過 50 字」 |
| 金額 | 必填、> 0 | 「請輸入金額」/「金額必須大於 0」 |
| 頻率 | 必填 | 「請選擇收費頻率」 |
| 計費方向 | 必填 | 「請選擇計費方向」 |

## 月份篩選預設邏輯

- 車趟紀錄 Tab 和結算明細 Tab 的月份選擇器：
  - **預設值**：當月（`dayjs().format('YYYY-MM')`）
  - **可選範圍**：系統最早資料月份 ~ 當月
  - 變更月份後自動重新查詢

## 相關規格

- [頁面路由總覽](./pages-overview.md)
- [客戶分類業務規則](../business-rules/customer-classification.md)
- [UI 規格索引](./README.md)
