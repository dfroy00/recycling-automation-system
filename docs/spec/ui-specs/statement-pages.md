# 結算明細與報表頁面規格

> **版本**：3.0
> **日期**：2026-02-13

## StatementsPage `/statements`

### 篩選列

- 月份選擇 + 客戶下拉 + 狀態篩選

### 車趟預覽區塊

選擇客戶 + 月份後自動顯示：

- 摘要：共 N 趟、品項總筆數、日期範圍
- 車趟表格（可展開品項明細）
- 「產出月結明細」按鈕
- 已有明細時提示「該月已有明細紀錄」

### 明細資料表格

- 欄位：客戶、月份、應收、應付、淨額、狀態、操作
- 操作按鈕依狀態顯示：審核（draft）、開票（approved）、寄送、作廢
- 批次產出按鈕

## ReportsPage `/reports`

- 客戶月結 PDF 下載：選擇客戶 + 月份 → 下載
- 站區彙總 Excel 下載：選擇站區 + 月份 → 下載

## 車趟預覽載入狀態

| 狀態 | 顯示 |
|------|------|
| 未選擇客戶或月份 | 提示文字：「請選擇客戶與月份以預覽車趟」 |
| 載入中 | Spin 覆蓋層 + 「載入車趟資料中...」 |
| 載入完成有資料 | 顯示摘要 + 車趟表格 + 「產出月結明細」按鈕 |
| 載入完成無資料 | Empty State：「該客戶在選定月份沒有車趟紀錄」 |
| 載入失敗 | 錯誤提示 + 「重試」按鈕 |

## 操作確認文字

| 操作 | 確認對話框文字 | 按鈕文字 |
|------|-------------|---------|
| 產出月結明細 | 「確定產出 {客戶名稱} {年月} 的月結明細？」 | 「確定產出」 |
| 審核明細 | 「確定審核通過此明細？審核後金額不可修改。」 | 「確定審核」 |
| 開票 | 「確定標記此明細為已開票？」 | 「確定」 |
| 寄送 | 「確定寄送此明細給客戶？」 | 「確定寄送」 |
| 作廢 | 「確定作廢此明細？作廢後可重新產出。」 | 「確定作廢」 |

## 批次產出進度提示

1. 點擊「批次產出」按鈕後：
   - 按鈕進入 loading 狀態，文字改為「批次產出中...」
   - 顯示進度提示：「正在產出第 {n}/{total} 筆...」
2. 全部完成後：
   - Toast 成功訊息：「批次產出完成，共產出 {n} 筆明細」
   - 若有跳過的（已存在明細）：Toast 警告：「{m} 筆已有明細紀錄，已跳過」
3. 部分失敗：
   - Toast 錯誤訊息：「批次產出部分失敗，{k} 筆成功、{j} 筆失敗」

## 報表下載失敗處理

| 場景 | 行為 |
|------|------|
| API 回傳 503（並發限制） | Toast：「報表產出中，請稍候再試」 |
| API 回傳 404（無資料） | Toast：「找不到符合條件的報表資料」 |
| API 回傳 500（產出錯誤） | Toast：「報表產出失敗，請稍後再試」 |
| 下載逾時 | Toast：「報表檔案過大，請縮小查詢範圍後重試」 |

- 下載按鈕在請求期間顯示 loading 狀態
- 下載成功後由瀏覽器自動觸發檔案下載

## 相關規格

- [頁面路由總覽](./pages-overview.md)
- [計費引擎](../business-rules/billing-engine.md)
- [明細寄送規則與防重複機制](../business-rules/settlement-flow.md)
- [UI 規格索引](./README.md)
