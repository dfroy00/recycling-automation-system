# 系統架構

> **版本**：3.0
> **日期**：2026-02-13

---

## 1. 業務背景

公司經營 **7 個回收站區**，向配合客戶收取回收物（紙類、鐵類、五金類、塑膠類、雜項），每月結算帳務。

公司目前有 **三套獨立系統**，彼此之間無資料串接，月底靠人工彙整：

| 系統 | 功能 | 問題 |
|------|------|------|
| CRM（自有） | 客戶基本資料管理 | 資料陳舊、欄位不完整 |
| POS（外購） | 過磅秤重、列印磅單 | 無法匯出結構化資料 |
| 車機系統（外購） | GPS 軌跡、派車管理 | 獨立運作、人工比對車趟 |

本系統目標：建立統一平台，整合三套系統資料，自動化月結帳務流程。

## 2. MVP 範圍

**做：**
- 基礎資料 CRUD（站區、品項、客戶、行號、合約）
- 車趟管理（手動輸入 + 外部系統同步）
- 計費引擎（品項層級方向定價、車趟費、附加費用）
- 月結明細產出、審核、開票、寄送、作廢流程
- 報表輸出（PDF 月結明細、Excel 站區彙總）
- Email 通知寄送
- 外部系統 Adapter 整合（Mock 實作）
- 排程自動化（月結產出、寄送檢查、合約到期提醒）
- **三層權限系統**（super_admin / site_manager / site_staff，站區級資料隔離）
- **客戶詳情頁**（Tab 架構整合合約/附加費用/車趟/明細）
- **合約與客戶聯動**（新增合約自動更新客戶類型為簽約）

**不做：**
- LINE 通知（預留介面，不實作）
- 真實 POS / 車機 API 接入（使用 Mock DB 模擬）
- 報價簽約流程（系統外處理，只管理已簽約的合約）
- 車趟排程預排
- 政府假日 API 串接（手動維護假日）
- 月結全自動（人工審核階段）

## 3. 技術選型

| 層級 | 技術 |
|------|------|
| 前端 | React 18 + TypeScript + Vite |
| UI 元件庫 | Ant Design 5 |
| 前端狀態管理 | React Query (@tanstack/react-query) |
| 路由 | react-router-dom |
| 後端 | Express.js + TypeScript |
| ORM | Prisma |
| 資料庫 | PostgreSQL 16 |
| 容器化 | Docker Compose |
| PDF 產出 | pdfkit + Noto Sans TC 中文字型 |
| Excel 產出 | exceljs |
| 排程 | node-cron |
| 郵件 | nodemailer (SMTP) |
| 測試 | Jest + Supertest |

## 4. 系統架構圖

```
┌──────────────────┐     ┌──────────────────┐
│   React SPA      │────>│  Express REST    │
│   (port 5173)    │     │  API (port 3000) │
└──────────────────┘     └────────┬─────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    │             │             │
              ┌─────▼─────┐ ┌────▼────┐ ┌──────▼──────┐
              │ PostgreSQL │ │ Adapter │ │   SMTP      │
              │ (port 5432)│ │  Layer  │ │   Server    │
              └───────────┘ └────┬────┘ └─────────────┘
                                 │
                    ┌────────────┼────────────┐
                    │                         │
              ┌─────▼─────┐           ┌───────▼───────┐
              │  POS 系統  │           │  車機系統      │
              │  (Mock DB) │           │  (Mock DB)    │
              └───────────┘           └───────────────┘
```

## 5. 非功能需求

### 5.1 安全性

| 項目 | 規格 |
|------|------|
| JWT 密鑰 | 啟動時檢查 `JWT_SECRET` 環境變數，未設定直接拋錯終止。**禁止** fallback 預設值 |
| JWT 有效期 | 預設 8 小時 |
| 密碼雜湊 | bcrypt, salt rounds = 10 |
| 密碼策略 | 最少 8 字元，至少包含 1 個數字 |
| 速率限制 | 登入 5 次/分鐘/IP、一般 API 100 次/分鐘/IP、報表 10 次/分鐘/IP |
| 安全標頭 | 使用 helmet 套件 |
| CORS | 限制允許來源（`CORS_ORIGIN` 環境變數） |

### 5.2 錯誤處理

- **全域錯誤中介層**：統一攔截未處理錯誤，回傳 `{ error: string }`
- **Prisma 錯誤轉換**：P2025 → 404、P2002 → 409、P2003 → 400
- **生產環境**：隱藏堆疊追蹤
- **前端 Error Boundary**：全域錯誤邊界元件
- **月結批次錯誤**：部分客戶失敗不影響其他客戶，失敗記 SystemLog

### 5.3 效能

- **分頁**：所有列表 API 預設分頁 20 筆，`?all=true` 最大 1000 筆
- **報表並發**：最多 5 個同時產出
- **月結非同步**：批次產出回傳 202，背景處理
- **批次月結**：`Promise.allSettled` 並行處理（並行上限 5）
- **React Query 快取**：站區/品項 staleTime 5 分鐘、儀表板 staleTime 30 秒

### 5.4 通知

**Email**：
- SMTP 寄送（nodemailer）
- 月結明細寄送：附帶 PDF 附件
- 合約到期提醒：寄送至管理員信箱
- 排程失敗報告：寄送至管理員信箱

**LINE**：
- 預留介面，尚未實作
- 呼叫時記錄 SystemLog 並跳過

### 5.5 報表格式

**客戶月結明細 PDF**：
1. 標題：資源回收管理系統 / 月結明細表
2. 客戶資訊：月份、名稱、站區、類型、聯絡人、電話、地址
3. 收運明細表格：日期 / 品項 / 數量 / 單位 / 單價 / 方向 / 金額
4. 車趟費
5. 附加費用
6. 彙總：應收小計 / 應付小計 / 淨額 / 稅額 / 總額
7. 匯款帳戶
8. **中文字型**：使用 Noto Sans TC（放在 `backend/assets/fonts/NotoSansTC-Regular.ttf`）

**站區彙總 Excel**：
- 工作表一（客戶總額）：每個客戶一列，含各項金額
- 工作表二（品項彙總）：按品項聚合數量和金額

### 5.6 備份

- 每日 02:00 執行 `pg_dump`
- 保留 30 天
- 每月 4 號額外全備
