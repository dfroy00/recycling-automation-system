# SDD 五階段變更流程

> **版本**：2.0
> **日期**：2026-02-13
> **用途**：定義系統規格變更的標準流程，確保規格文件與程式碼保持同步

---

## 流程概覽

```
Design → Spec Update → Implementation Plan → Test → Code
（設計）  （更新規格）   （實作計畫）          （測試） （寫程式碼）
```

所有對系統行為的變更（新功能、修改既有行為、修正規格錯誤）都必須經過此五階段流程。

---

## 階段一：Design（設計）

**目的**：釐清需求、探索方案、做出架構決策。

**產出**：`docs/plans/designs/YYYY-MM-DD-<topic>.md`

**內容要求**：
- 問題描述：為什麼需要這個變更？
- 方案探索：列出可行方案及各自的 trade-off
- 決策紀錄：選定方案及理由
- 影響範圍：會影響哪些 Spec 文件（列出路徑）

**規範**：
- 檔名格式：`YYYY-MM-DD-<簡短描述>.md`
- 設計文件不可修改程式碼，只做分析和決策

---

## 階段二：Spec Update（更新規格）

**目的**：將設計決策轉化為正式規格，更新對應的 Spec 文件。

**操作方式**：
1. 根據 Design 文件的影響範圍，逐一更新 `docs/spec/` 下的對應文件
2. 每份文件更新後遞增版本號、更新日期
3. 跨文件引用使用 Markdown 相對連結

**原則**：
- 一次變更只改最小範圍的 Spec 文件
- 不在 Spec 中寫實作細節（如何做），只寫行為規格（做什麼）
- 新增內容標記 `> [!NOTE] v3.1 新增`，方便追蹤

---

## 階段三：Implementation Plan（實作計畫）

**目的**：將更新後的 Spec 轉化為可執行的開發任務清單。

**產出**：`docs/plans/implementations/YYYY-MM-DD-<topic>.md`

**內容要求**：
- 參照的 Spec 文件列表（附連結）
- 任務清單（按執行順序排列）
- 每個任務標明：影響的檔案、預估複雜度、依賴關係
- 測試計畫：需要新增/修改的測試案例

**規範**：
- 檔名格式：`YYYY-MM-DD-<簡短描述>.md`
- 任務粒度：每個任務可在 1-2 小時內完成

---

## 階段四：Test（測試）

**目的**：根據 Spec 的驗收條件撰寫測試，測試先行（TDD），確保實作前已有明確的通過標準。

**產出**：對應的測試檔案（單元測試 / 整合測試 / E2E 測試）

**操作方式**：
1. 從 Spec 文件中提取所有 `### 驗收條件` 段落
2. 將每個 `Given / When / Then` 轉化為測試案例
3. 確認測試覆蓋 Implementation Plan 中列出的所有任務
4. 執行測試，確認全部為「紅燈」（尚未實作，應該失敗）

**原則**：
- 每個驗收條件至少對應一個測試案例
- 測試命名遵循 `should <預期行為> when <觸發條件>` 格式
- 先寫測試再寫程式碼，不可跳過
- 邊界情境測試與正常路徑測試同等重要
- 測試矩陣中的每個場景都需要有對應測試

**測試分類**：

| 層級 | 範圍 | 對應 Spec |
|------|------|----------|
| 單元測試 | 業務規則函式（計費引擎、快照邏輯等） | business-rules/*.md |
| 整合測試 | API 端點（含認證、授權、資料驗證） | apis/*.md |
| E2E 測試 | 使用者操作流程（表單提交、頁面導航） | ui-specs/*.md |

---

## 階段五：Code（寫程式碼）

**目的**：依照 Implementation Plan 實作程式碼，使所有測試從紅燈轉為綠燈。

**操作方式**：
1. 按照 Plan 中的任務清單順序實作
2. 每完成一個任務，執行對應測試確認通過
3. 每完成一個任務，在 Plan 中標記完成
4. 實作中發現 Spec 不完整或有誤，回到階段二更新 Spec

**原則**：
- 程式碼必須符合 Spec 描述的行為
- 發現 Spec 與實際需求不符時，先更新 Spec 再改 Code
- 不做 Spec 未定義的功能
- 所有測試通過後才可視為任務完成

---

## 快速修復例外

以下情況可跳過 Design 階段，直接從 Spec Update 開始：
- Bug 修復（Spec 定義的行為未正確實作）
- 錯字修正
- 依賴套件升級

但仍需更新對應的 Spec 文件（如有影響）、建立 Implementation Plan 並撰寫測試。

---

## 文件管理

| 分類 | 路徑 | 說明 |
|------|------|------|
| 規格文件 | `docs/spec/` | 正式規格，持續維護 |
| 設計文件 | `docs/plans/designs/` | 決策紀錄，完成後歸檔 |
| 實作計畫 | `docs/plans/implementations/` | 任務清單，完成後歸檔 |
| 歸檔 | `docs/plans/archive/` | 已完成的 designs/implementations |

詳見 [Plans 管理規範](../../plans/README.md)。
