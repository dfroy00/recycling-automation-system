# 回收業務自動化系統 — MVP 全面重寫設計

> 日期：2026-02-10
> 狀態：設計完成，待實作
> 策略：全部重寫，保留技術選型（React + Express + Prisma + PostgreSQL）

---

## 1. 問題描述 / 概述

現有系統的業務模型與實際營運有落差（例如 A/B/C/D 計費分類無法反映品項層級的計費方向差異），需要基於正確的業務理解全面重寫。

### MVP 原則

- 資料來源：CRUD 手動輸入 + **Adapter 模式接入外部系統（POS/車機）**
- 外部系統整合：透過 Adapter 抽象層，MVP 使用 Mock DB 模擬，未來無縫切換真實 API
- 通知寄送：Email 先做，LINE 預留接口後補
- 權限分離：不做，所有使用者同等權限
- 審核流程：人工審核，穩定後再改自動
- 報價簽約流程：不做（系統外處理），只管理已簽約的合約
- 車趟排程預排：不做
- 假日資料：系統內手動維護

---

## 2. 系統架構

### 現有系統環境

公司目前有 **三套獨立系統**，彼此之間無資料串接，月底靠人工彙整：

| 系統 | 主要功能 | 產出資料 |
|------|---------|---------|
| **POS 系統** | 收運現場作業 | 進銷貨品項、重量、單價 |
| **車機系統** | 車輛管理 | 車趟紀錄、GPS 軌跡、派車調度 |
| **CRM 系統** | 客戶與帳務管理 | 客戶資料、合約、月結明細（全包型） |

### 整合策略

本系統**取代 CRM 系統**，同時透過 **Adapter 模式**整合 POS 與車機系統：

```
┌─────────────────────────────────────────────────────────┐
│                  回收業務自動化系統（本系統）                │
│                                                         │
│  ┌──────────────────────────────────────────────────┐   │
│  │                  業務邏輯層                        │   │
│  │  客戶管理 / 合約管理 / 計費引擎 / 月結 / 報表       │   │
│  └────────────────────┬─────────────────────────────┘   │
│                       │                                  │
│  ┌────────────────────▼─────────────────────────────┐   │
│  │              Adapter 抽象層                        │   │
│  │                                                   │   │
│  │  ┌─────────────────┐  ┌─────────────────────┐    │   │
│  │  │  IPosAdapter    │  │  IVehicleAdapter     │    │   │
│  │  │  POS 系統接口    │  │  車機系統接口         │    │   │
│  │  └────────┬────────┘  └──────────┬──────────┘    │   │
│  └───────────┼──────────────────────┼───────────────┘   │
│              │                      │                    │
│    ┌─────────▼────────┐  ┌─────────▼──────────┐        │
│    │ MockPosAdapter   │  │ MockVehicleAdapter  │        │
│    │ （開發用 Mock DB）│  │ （開發用 Mock DB）   │        │
│    └──────────────────┘  └────────────────────┘        │
└─────────────────────────────────────────────────────────┘
                    │                      │
     ▼ 未來切換 ▼                ▼ 未來切換 ▼
┌──────────────────┐      ┌────────────────────┐
│ RealPosAdapter   │      │ RealVehicleAdapter  │
│ （真實 POS API） │      │ （真實車機 API）     │
└──────────────────┘      └────────────────────┘
```

### Adapter 介面定義

#### IPosAdapter（POS 系統接口）

```typescript
interface IPosAdapter {
  // 讀取：從 POS 取得收運紀錄
  getCollectionRecords(params: {
    siteId?: number       // 站區篩選
    customerId?: number   // 客戶篩選
    dateFrom: Date        // 起始日期
    dateTo: Date          // 結束日期
  }): Promise<PosCollectionRecord[]>

  // 讀取：取得指定時間後的最新紀錄（增量同步用）
  getLatestRecords(since: Date): Promise<PosCollectionRecord[]>

  // 寫入：同步客戶資料到 POS
  syncCustomer(customer: CustomerSyncData): Promise<void>

  // 寫入：同步合約品項定價到 POS
  syncContractPrices(contractItems: ContractPriceSyncData[]): Promise<void>
}
```

#### IVehicleAdapter（車機系統接口）

```typescript
interface IVehicleAdapter {
  // 讀取：從車機取得車趟紀錄
  getTripRecords(params: {
    siteId?: number   // 站區篩選
    dateFrom: Date    // 起始日期
    dateTo: Date      // 結束日期
  }): Promise<VehicleTripRecord[]>

  // 讀取：取得車輛即時狀態
  getVehicleStatus(): Promise<VehicleStatus[]>

  // 寫入：同步客戶資料到車機
  syncCustomer(customer: CustomerSyncData): Promise<void>

  // 寫入：派車指令
  dispatchTrip(dispatch: DispatchData): Promise<void>
}
```

### Adapter 切換機制

透過環境變數控制使用 Mock 或 Real 實作：

```env
# .env
POS_ADAPTER_MODE=mock      # mock | real
VEHICLE_ADAPTER_MODE=mock   # mock | real

# Real 模式需要的連線資訊（未來使用）
POS_API_URL=
POS_API_KEY=
VEHICLE_API_URL=
VEHICLE_API_KEY=
```

```typescript
// backend/src/adapters/index.ts — 工廠函數
import { IPosAdapter } from './pos.adapter'
import { IVehicleAdapter } from './vehicle.adapter'
import { MockPosAdapter } from './mock/mock-pos.adapter'
import { MockVehicleAdapter } from './mock/mock-vehicle.adapter'

export function createPosAdapter(): IPosAdapter {
  if (process.env.POS_ADAPTER_MODE === 'real') {
    // 未來實作
    throw new Error('Real POS adapter not implemented yet')
  }
  return new MockPosAdapter()
}

export function createVehicleAdapter(): IVehicleAdapter {
  if (process.env.VEHICLE_ADAPTER_MODE === 'real') {
    // 未來實作
    throw new Error('Real Vehicle adapter not implemented yet')
  }
  return new MockVehicleAdapter()
}
```

### Adapter 健康檢查

每個 Adapter 實作 `healthCheck()` 方法，回報連線狀態。系統啟動時和排程執行前自動檢查：

```typescript
// 健康檢查介面（IPosAdapter 和 IVehicleAdapter 皆須實作）
interface IAdapterHealthCheck {
  healthCheck(): Promise<{
    status: 'ok' | 'error'        // 連線狀態
    mode: 'mock' | 'real'         // 當前模式
    message?: string              // 錯誤訊息（僅 error 時）
    lastSyncAt?: Date             // 上次成功同步時間
  }>
}
```

**健康檢查 API 端點**：`GET /api/sync/status`（已列於 API 路由總覽）

**檢查時機：**
- 系統啟動時：自動執行健康檢查，記錄到 system_logs
- 排程執行前：同步排程觸發前先檢查 Adapter 狀態，若 error 則跳過同步並通知管理員
- 手動觸發：透過同步管理頁面的「測試連線」按鈕

**錯誤處理策略：**
- Mock 模式：healthCheck 恆回 `ok`（Mock DB 無連線問題）
- Real 模式：嘗試呼叫外部 API 的 ping/heartbeat 端點
- 連線失敗時：記錄到 system_logs，不阻擋手動 CRUD 操作，僅阻擋自動同步

### 資料同步方向

```
                    本系統                     POS 系統
              ┌──────────────┐          ┌──────────────┐
              │              │ ◄─ 讀取 ─ │ 品項/重量/單價│
              │  客戶管理    │ ─ 寫入 ►  │ 客戶清單     │
              │  合約管理    │ ─ 寫入 ►  │ 合約品項定價  │
              │  計費引擎    │           │              │
              │  月結/報表   │           └──────────────┘
              │              │
              │              │          ┌──────────────┐
              │              │ ◄─ 讀取 ─ │ 車趟紀錄     │
              │              │ ◄─ 讀取 ─ │ GPS 軌跡     │
              │              │ ─ 寫入 ►  │ 客戶清單     │
              │              │ ─ 寫入 ►  │ 派車指令     │
              └──────────────┘          └──────────────┘
                                          車機系統
```

| 方向 | 來源 → 目標 | 資料內容 |
|------|------------|---------|
| **POS → 本系統** | 讀取 | 收運品項、重量、單價 |
| **本系統 → POS** | 寫入 | 客戶清單、合約品項定價 |
| **車機 → 本系統** | 讀取 | 車趟紀錄、車輛狀態 |
| **本系統 → 車機** | 寫入 | 客戶清單、派車指令 |

### 外部系統資料對應策略

外部系統（POS/車機）使用「站區名稱」和「客戶名稱」（字串），本系統使用 FK（整數 ID）。同步時需要名稱對應：

```
外部系統資料                     本系統
site_name: "北區"    ──比對──►  sites.name = "北區"  → site_id = 1
customer_name: "大明" ──比對──►  customers.name = "大明" → customer_id = 5
item_name: "總紙"    ──比對──►  items.name = "總紙"  → item_id = 1
```

**對應規則：**
- 以**名稱精確比對**為主（外部系統的名稱必須與本系統一致）
- 比對失敗時：記錄到 system_logs，標記該筆為「待人工處理」，不自動建立
- Mock 階段：seed 假資料時確保名稱一致，不會有比對問題

### POS 同步定價策略

POS 收運紀錄包含 `unit_price`（POS 端單價），同步到本系統建立 trip_items 時的定價邏輯：

| 客戶類型 | 單價來源 | billing_direction 來源 | POS 端 unit_price 處理 |
|---------|---------|----------------------|----------------------|
| 簽約客戶 | **本系統合約價**（自動帶入） | 合約設定 | 忽略（POS 端單價僅供參考，不影響計費） |
| 臨時客戶 | **POS 端 unit_price** | 預設 receivable，可人工調整 | 直接作為 trip_items.unit_price |

> POS 端單價可能與合約價不同（POS 可能未及時更新），以本系統合約價為準。

### POS 與車機同步去重策略

POS 和車機系統可能對同一趟收運各有一筆紀錄，同步時需避免建立重複車趟：

```
去重比對鍵（依優先順序）：
1. external_id 精確比對（最可靠，同來源系統的唯一識別）
2. 同一客戶 + 同一日期 + 同一站區 + 時間區間（±30分鐘）

├─ POS 同步先行 → 建立 trip + trip_items（含品項重量）
├─ 車機同步後行 → 先比對 external_id，再比對「客戶+日期+站區+時間」
│   ├─ 匹配到已存在的 trip → 補充 driver + vehicle_plate，不建立新 trip
│   └─ 無匹配 → 建立新 trip（source=vehicle_sync），需人工補充品項
└─ 同一客戶同一天同一站區多趟：依時間區間區分不同 trip
```

**規則：**
- POS 同步建立的 trip：`source=pos_sync`，包含品項明細
- 車機同步時，**優先以 `external_id` 精確比對**（避免同一筆重複匯入），再以「客戶+日期+站區+時間區間」模糊比對
- 同一客戶同一天同一站區可能有多趟收運，**必須搭配時間資訊區分**，純「客戶+日期+站區」不足以唯一識別
- 車機同步未匹配到 trip 時，建立新 trip（`source=vehicle_sync`），不含品項明細，需人工補充
- 同步順序建議：先 POS → 再車機
- 每筆同步紀錄的 `external_id` 必須記錄，供後續追溯和去重

---

## 3. 業務模型

### 核心業務

公司經營 7 個站區（未來可能增減），向配合客戶收取回收物。

### 客戶分類

| 類型 | 說明 | 計價方式 |
|------|------|---------|
| **簽約客戶** | 正式簽約，有合約品項定價 | 依合約品項單價和方向 |
| **臨時客戶** | 臨時叫車收運，事先報價後派車 | 每次單獨報價，手動輸入 |

兩者都要在系統中管理。

### 報價簽約流程（系統外處理）

```
客戶詢價 → 站區主任擬報價 → 總部審核通過 → 寄送報價單 → 簽約
```

> MVP 不做此流程，系統僅管理已簽約的合約資料。

### 完整業務流程圖

```
═══════════════════════════════════════════════════════════════════
  一、客戶進入
═══════════════════════════════════════════════════════════════════

  ┌─────────────┐          ┌─────────────┐
  │  簽約客戶    │          │  臨時客戶    │
  └──────┬──────┘          └──────┬──────┘
         │                        │
         ▼                        ▼
  ┌──────────────┐        ┌──────────────┐
  │ 報價→審核→簽約│        │ 來電→事先報價 │
  │（系統外處理） │        │  →確認後派車  │
  └──────┬───────┘        └──────┬───────┘
         │                        │
         ▼                        ▼
  ┌──────────────┐        ┌──────────────┐
  │ 系統建立客戶  │        │ 系統建立客戶  │
  │ + 合約       │        │ （類型=臨時） │
  │ + 合約品項    │        │              │
  └──────┬───────┘        └──────┬───────┘
         │                        │
         └───────────┬────────────┘
                     ▼
              ┌──────────────┐
              │ 設定客戶參數   │
              │ • 車趟費      │
              │ • 明細方式    │
              │ • 付款方式    │
              │ • 寄送日      │
              │ • 發票設定    │
              │ • 通知方式    │
              └──────┬───────┘
                     ▼

═══════════════════════════════════════════════════════════════════
  二、日常收運
═══════════════════════════════════════════════════════════════════

              ┌──────────────┐
              │ 司機出車收運   │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ 收運完成      │
              │ 資料進系統    │
              └──────┬───────┘
                     │
           ┌─────────┴─────────────────┐
           ▼                           ▼
    ┌────────────┐              ┌──────────────┐
    │系統手動建立 │              │ POS/車機同步  │
    │  （CRUD）  │              │（Adapter拉取）│
    └─────┬──────┘              └──────┬───────┘
          └─────────────┬──────────────┘
                     ▼
              ┌──────────────────┐
              │ 建立車趟 + 品項   │
              │                  │
              │ 簽約客戶:         │
              │  自動帶入合約價   │
              │  快照單價+方向    │
              │                  │
              │ 臨時客戶:         │
              │  手動輸入報價     │
              │  手動選擇方向     │
              └──────┬───────────┘
                     │
           ┌─────────┴──────────┐
           ▼                    ▼
    ┌──────────────┐    ┌──────────────────┐
    │ 月結明細客戶  │    │ 按趟明細客戶      │
    │ 累積至月底    │    │ 立即產出單趟明細   │
    │              │    │ （draft）         │
    └──────┬───────┘    └──────┬───────────┘
           │                    │
           ▼                    ▼

═══════════════════════════════════════════════════════════════════
  三、月結流程（月結明細客戶）
═══════════════════════════════════════════════════════════════════

    每月 1-4 號              5 號（遇假日提前）
    ┌──────────────┐     ┌──────────────────┐
    │ 資料補齊期    │ ──→ │ 系統自動產出      │
    │ 補登/修正     │     │ 全部月結客戶明細   │
    │ 上月車趟資料  │     │ （draft 狀態）    │
    └──────────────┘     └────────┬─────────┘
                                  │
                                  ▼
                         ┌──────────────────┐
                         │ 人工審核期        │
                         │ 行政/主管逐筆確認  │
                         └────────┬─────────┘
                                  │
                        ┌─────────┴─────────┐
                        ▼                   ▼
                 ┌────────────┐     ┌──────────────┐
                 │ 審核通過    │     │ 退回修正      │
                 │ (approved) │     │ (rejected)   │
                 └─────┬──────┘     └──────┬───────┘
                       │                    │
                       │              修正後重新提交
                       │                    │
                       ▼                    │
                ┌─────────────┐             │
                │ 等待寄送日   │◄────────────┘
                └─────┬───────┘
                      │
                      ▼

═══════════════════════════════════════════════════════════════════
  四、寄送與付款
═══════════════════════════════════════════════════════════════════

         每日 09:00 排程檢查
         ┌───────────────────────┐
         │ 今天是否有客戶到寄送日？│
         └───────────┬───────────┘
                     │ 是
                     ▼
         ┌───────────────────────┐
         │ 該客戶有已審核的明細？  │
         └───────────┬───────────┘
                     │ 是
                     ▼
         ┌───────────────────────┐
         │ 需要開發票？            │
         └─────┬──────────┬──────┘
               │ 是        │ 否
               ▼           ▼
        ┌────────────┐ ┌──────────┐
        │ 開立發票    │ │ 只寄明細  │
        │ 淨額/分開   │ │          │
        └─────┬──────┘ └─────┬────┘
              │               │
              └───────┬───────┘
                      ▼
              ┌──────────────┐
              │ 自動寄送      │
              │ Email / LINE │
              └──────┬───────┘
                     │
                     ▼
              ┌──────────────┐
              │ 狀態 → sent   │
              └──────┬───────┘
                     │
           ┌─────────┴─────────┐
           ▼                   ▼
    ┌──────────────┐   ┌──────────────┐
    │ 一次付清      │   │ 按趟分次付款  │
    │ 整筆匯款     │   │ 拆趟次匯款   │
    │ 至客戶帳戶    │   │ 至同一帳戶   │
    └──────────────┘   └──────────────┘

═══════════════════════════════════════════════════════════════════
  五、系統自動排程
═══════════════════════════════════════════════════════════════════

    ┌──────────────────────────────────────────────┐
    │ 每月 5 號 09:00  │ 月結明細自動產出            │
    │ 每日 09:00      │ 檢查寄送日 + 自動寄送       │
    │ 每日 09:00      │ 通知重試（寄送失敗自動重試） │
    │ 每日 10:00      │ 合約到期掃描（30/15/7天）   │
    └──────────────────────────────────────────────┘
    ※ 所有排程遇假日（週六日+國定假日）提前至前一工作日
```

### 計費特性（高度客製化）

- **品項層級**：每個品項各自設定單價和費用方向
- **費用方向**：應收（客戶付我方）/ 應付（我方付客戶）/ 不收費
- **同一客戶不同品項可有不同方向**（例如總紙應付、PET 應收）
- **車趟費**：我方向客戶收取，按次或按月計算
- **附加費用**：自由輸入名稱和固定金額，每筆各自設定應收或應付方向，支援按月或按趟頻率
- **明細產出**：月結（整月一份）/ 按趟（每趟一份），與簽約/臨時類型獨立設定
- **付款方式**：一次付清 / 按趟分次付款（依客戶需求）
- **明細×付款有效組合**：
  - 月結 + 一次付清 ✓（最常見：整月一份明細，一次匯款）
  - 月結 + 按趟分付 ✓（月結明細一份，但付款拆趟次匯款）
  - 按趟 + 一次付清 ✓（每趟一份明細，每份各自付清）
  - ~~按趟 + 按趟分付~~（等同「按趟+一次付清」，系統不提供此組合）
- **發票**：需要開立 / 不需要開立（明細一律都會產出）
- **開票方式**：淨額開一張（預設）/ 應收應付分開（依客戶需求，僅需開票的客戶適用）
- **稅額**：5% 營業稅
- **發票寄送**：Email（MVP），LINE（後補）

---

## 4. 需求清單

### 基礎資料管理
1. 站區 CRUD
2. 公司統一品項清單 CRUD
3. 客戶 CRUD（含車趟費設定、結算方式、通知偏好、匯款帳戶）
4. 客戶附加費用 CRUD（自由輸入名稱+固定金額+方向+頻率）
5. 合約 CRUD（含期限管理）
6. 合約品項 CRUD（品項 + 單價 + 費用方向）

### 日常營運
7. 車趟紀錄建立（手動 CRUD / POS 同步 / 車機同步）
8. 車趟品項明細（簽約客戶自動帶入合約價快照，臨時客戶手動輸入）
9. 車趟/品項資料修正

### 月結與發票
11. 每月 5 號自動產出全部月結客戶明細（草稿狀態）
12. 人工審核流程（審核通過 / 退回修正）
13. 依各客戶設定寄送日自動寄送已審核明細（Email，預設 15 號）
14. 按趟結算客戶：每趟完成時獨立產出明細
15. 遇假日（週六日 + 國定假日）提前至前一個工作日

### 報表
16. 客戶結算明細 PDF
17. 站區彙總報表 Excel

### 外部系統整合
18. Adapter 抽象層（IPosAdapter、IVehicleAdapter 介面）
19. Mock DB 模擬資料（mock_pos_collections、mock_vehicle_trips）
20. POS 資料同步（拉取收運紀錄、推送客戶/合約定價）
21. 車機資料同步（拉取車趟紀錄、推送客戶資料、派車）
22. Adapter 模式切換（環境變數控制 Mock/Real）

### 系統管理
23. 使用者管理（不分權限）
24. 國定假日管理
25. 排程狀態查詢 + 手動觸發
26. 合約到期提醒（30/15/7 天）
27. 通知重試（寄送失敗自動重試）

---

## 5. 資料模型

### ER 關係圖

```
┌─────────────┐     ┌──────────────┐     ┌────────────────┐
│   sites     │     │  customers   │     │   contracts    │
│ 站區主檔     │←───│  客戶主檔     │←───│   合約         │
└─────────────┘     └──────┬───────┘     └───────┬────────┘
                           │                      │
                    ┌──────▼───────┐     ┌────────▼────────┐
                    │customer_fees │     │ contract_items   │
                    │客戶附加費用   │     │ 合約品項(核心!)   │
                    └──────────────┘     └─────────────────┘

┌─────────────┐
│   items     │←──────────────────────────────────┐
│ 品項主檔     │                                    │
└──────┬──────┘                                    │
       │ 被引用於                                   │
       ▼                                           │
┌──────────────┐     ┌────────────────┐            │
│    trips     │←───│  trip_items    │────────────┘
│ 車趟紀錄      │     │ 趟次品項明細   │
└──────────────┘     └────────────────┘

┌────────────────────┐
│   statements      │
│ 結算明細(月結/按趟) │
└────────────────────┘

┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   users      │  │  holidays    │  │  system_logs │
│  使用者       │  │  假日主檔     │  │  系統日誌     │
└──────────────┘  └──────────────┘  └──────────────┘

--- Mock DB（外部系統模擬） ---

┌─────────────────────┐  ┌─────────────────────┐
│mock_pos_collections │  │ mock_vehicle_trips  │
│模擬 POS 收運紀錄     │  │ 模擬車機車趟紀錄     │
└─────────────────────┘  └─────────────────────┘
```

### 資料表定義

#### sites（站區主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| name | String (unique) | 站區名稱（外部系統名稱比對需唯一） |
| address | String? | 地址 |
| phone | String? | 聯絡電話 |
| status | String | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

> **型別慣例**：所有狀態/類型欄位在設計文件標示語意值（如 active/inactive），Prisma Schema 統一使用 `String` 型別而非 `enum`，驗證在應用層實作。此慣例適用於本文件所有標示 Enum 的欄位。

#### items（品項主檔）

> `id` 即為品項編號（流水號），不另設 code 欄位以避免重複。

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增，同時作為品項編號 |
| name | String (unique) | 品項名稱（全公司統一） |
| category | String? | 分類（UI 下拉選單：紙類/鐵類/五金類/塑膠類/雜項，可擴充） |
| unit | String | 計量單位（kg、件、袋等） |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### customers（客戶主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| site_id | Int (FK) | 所屬站區 |
| name | String | 客戶名稱 |
| contact_person | String? | 聯絡人 |
| phone | String? | 電話 |
| address | String? | 地址 |
| type | Enum | contracted（簽約）/ temporary（臨時） |
| trip_fee_enabled | Boolean | 是否收車趟費 |
| trip_fee_type | Enum? | per_trip（按次）/ per_month（按月） |
| trip_fee_amount | Decimal? | 車趟費金額 |
| statement_type | Enum | monthly（整月一份明細）/ per_trip（每趟一份明細） |
| payment_type | Enum | lump_sum（一次付清）/ per_trip（按趟分次付款） |
| statement_send_day | Int? | 明細寄送日（每月幾號，預設 15） |
| payment_due_day | Int? | 付款到期日（每月幾號，預設 15） |
| invoice_required | Boolean | 是否需要開立發票（明細一律產出） |
| invoice_type | Enum? | net（淨額開一張，預設）/ separate（應收應付分開），僅 invoice_required=true 時有效 |
| notification_method | Enum | email / line / both |
| notification_email | String? | 通知 Email |
| notification_line_id | String? | LINE ID（後補） |
| payment_account | String? | 匯款帳戶資訊 |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### customer_fees（客戶附加費用）

> 客戶可能有品項和車趟費以外的額外費用，費用名稱自由輸入，每筆各自設定方向（應收/應付）。

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK) | 所屬客戶 |
| name | String | 費用名稱（自由輸入，如：處理費、運輸加價、環保費） |
| amount | Decimal | 固定金額 |
| billing_direction | Enum | **receivable**（向客戶收取）/ **payable**（付給客戶） |
| frequency | Enum | **monthly**（按月收取）/ **per_trip**（按趟收取） |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### contracts（合約）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK) | 所屬客戶 |
| contract_number | String (unique) | 合約編號 |
| start_date | Date | 合約起始日 |
| end_date | Date | 合約到期日 |
| status | Enum | draft / active / expired / terminated |
| notes | String? | 備註 |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### contract_items（合約品項 — 計費核心）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| contract_id | Int (FK) | 所屬合約 |
| item_id | Int (FK) | 品項（引用品項主檔） |
| unit_price | Decimal | 合約單價 |
| billing_direction | Enum | **receivable**（客戶付我方）/ **payable**（我方付客戶）/ **free**（不收費） |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### trips（車趟紀錄）

> **關聯**：trips 與 customers、sites 皆建立 FK relation，可 include 聯查。

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK → customers) | 客戶 |
| site_id | Int (FK → sites) | 站區 |
| trip_date | Date | 收運日期 |
| trip_time | String? | 收運時間（如 08:30，用於同步去重比對，手動建立可為 null） |
| driver | String? | 司機 |
| vehicle_plate | String? | 車牌 |
| source | Enum | 資料來源：**manual**（手動建立）/ **pos_sync**（POS 同步）/ **vehicle_sync**（車機同步） |
| external_id | String? | 外部系統原始 ID（同步資料追溯用，手動為 null） |
| notes | String? | 備註 |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### trip_items（趟次品項明細）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| trip_id | Int (FK) | 所屬車趟 |
| item_id | Int (FK) | 品項（引用品項主檔） |
| quantity | Decimal | 數量（配合品項單位：kg、件、袋等） |
| unit | String | **快照**：收運當時的計量單位 |
| unit_price | Decimal | **快照**：收運當時的單價 |
| billing_direction | Enum | **快照**：收運當時的方向 |
| amount | Decimal | 計算金額（unit_price × quantity） |
| created_at | DateTime | 建立時間 |

> 快照設計：合約可能變動，但已收運的紀錄鎖定當時的單位、價格和方向。
> 簽約客戶 → 自動帶入合約價；臨時客戶 → 手動輸入報價。

#### statements（結算明細）

> 同時用於月結明細和按趟明細，以 `statement_type` 區分。

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK → customers) | 客戶 |
| statement_type | Enum | **monthly**（月結明細）/ **per_trip**（按趟明細） |
| trip_id | Int? (FK → trips) | 關聯車趟（僅 per_trip 類型使用，monthly 為 null） |
| year_month | String | 結算月份（如 2026-01） |
| item_receivable | Decimal | 品項應收小計 |
| item_payable | Decimal | 品項應付小計 |
| trip_fee_total | Decimal | 車趟費合計（固定為應收） |
| additional_fee_receivable | Decimal | 應收附加費用合計 |
| additional_fee_payable | Decimal | 應付附加費用合計 |
| total_receivable | Decimal | 應收合計 = 品項應收 + 車趟費 + 應收附加費用 |
| total_payable | Decimal | 應付合計 = 品項應付 + 應付附加費用 |
| net_amount | Decimal | 淨額 = 應收合計 - 應付合計（正=應收，負=應付） |
| subtotal | Decimal | 小計（淨額模式用淨額，分開模式各自計算） |
| tax_amount | Decimal | 稅額（5%） |
| total_amount | Decimal | 總額（小計 + 稅額） |
| receivable_subtotal | Decimal? | 分開開票：應收小計（僅 invoice_type=separate 有值） |
| receivable_tax | Decimal? | 分開開票：應收稅額 |
| receivable_total | Decimal? | 分開開票：應收總額 |
| payable_subtotal | Decimal? | 分開開票：應付小計 |
| payable_tax | Decimal? | 分開開票：應付稅額 |
| payable_total | Decimal? | 分開開票：應付總額 |
| detail_json | JSON | 完整明細（品項、車趟費、附加費用等） |
| status | Enum | draft / approved / rejected / invoiced / sent |
| reviewed_by | Int? (FK → users) | 審核人 |
| reviewed_at | DateTime? | 審核時間 |
| sent_at | DateTime? | 寄送時間 |
| sent_method | Enum? | email / line |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

> **狀態流轉**：需開票客戶 `draft → approved → invoiced → sent`，不需開票客戶 `draft → approved → sent`（跳過 invoiced）。退回流程：`draft → rejected → draft → approved`。
>
> **分開開票**：當客戶 `invoice_type=separate` 時，`receivable_*` 和 `payable_*` 欄位會有值，分別記錄應收端和應付端的小計/稅額/總額。`subtotal`/`tax_amount`/`total_amount` 在此模式下存淨額端的值。

#### holidays（假日主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| date | Date (unique) | 假日日期 |
| name | String | 假日名稱（如「春節」） |
| year | Int | 年份（方便查詢） |
| created_at | DateTime | 建立時間 |

#### users（使用者）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| username | String (unique) | 帳號 |
| password_hash | String | 密碼雜湊 |
| name | String | 姓名 |
| email | String? | Email |
| role | String | 角色（MVP 統一為 admin） |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### system_logs（系統日誌）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| event_type | String | 事件類型 |
| event_content | String | 事件內容 |
| user_id | Int? (FK → users) | 操作使用者 |
| created_at | DateTime | 建立時間 |

### Mock DB 資料表（外部系統模擬）

> 以下資料表用於 MVP 階段模擬 POS 和車機系統的資料。
> 透過 Adapter 切換，未來接入真實系統後即可停用。

#### mock_pos_collections（模擬 POS 收運紀錄）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| external_id | String (unique) | 模擬外部系統 ID（如 POS-20260105-001） |
| site_name | String | 站區名稱（對應 POS 端的站區） |
| customer_name | String | 客戶名稱（對應 POS 端的客戶） |
| collection_date | Date | 收運日期 |
| item_name | String | 品項名稱 |
| quantity | Decimal | 數量 |
| unit | String | 計量單位 |
| unit_price | Decimal | 單價 |
| imported | Boolean | 是否已匯入本系統（預設 false） |
| created_at | DateTime | 建立時間 |

#### mock_vehicle_trips（模擬車機車趟紀錄）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| external_id | String (unique) | 模擬外部系統 ID（如 VH-20260105-001） |
| site_name | String | 站區名稱（對應車機端的站區） |
| customer_name | String | 客戶名稱（對應車機端的客戶） |
| trip_date | Date | 車趟日期 |
| trip_time | String? | 出車時間（如 08:30） |
| driver | String | 司機姓名 |
| vehicle_plate | String | 車牌號碼 |
| status | String | 車趟狀態（pending / in_progress / completed） |
| imported | Boolean | 是否已匯入本系統（預設 false） |
| created_at | DateTime | 建立時間 |

---

## 6. 計費邏輯

### 計算單一客戶月結金額

```
計算月結（customer_id, year_month）
│
├─ 1. 查詢該客戶當月所有 trip_items（已快照單價和方向）
│
├─ 2. 依方向分組計算
│     ├─ 應收小計 = Σ(receivable 品項的 amount)
│     ├─ 應付小計 = Σ(payable 品項的 amount)
│     └─ free 品項不計金額
│
├─ 3. 車趟費計算
│     ├─ 不收 → 0
│     ├─ 按次 → 當月趟數 × 單次金額
│     └─ 按月 → 固定月費
│     （車趟費固定為應收）
│
├─ 3.5. 附加費用計算（customer_fees）
│     ├─ 查詢該客戶所有 status=active 的附加費用
│     ├─ frequency=monthly 的費用 → 直接加入（固定金額）
│     ├─ frequency=per_trip 的費用 → 當月趟數 × 金額
│     └─ 依各自 billing_direction 歸入應收或應付
│
├─ 4. 彙總
│     ├─ 應收合計 = 應收品項小計 + 車趟費 + 應收附加費用
│     ├─ 應付合計 = 應付品項小計 + 應付附加費用
│     └─ 淨額 = 應收合計 - 應付合計
│         正數 → 客戶付我方
│         負數 → 我方付客戶
│
├─ 5. 稅額計算（依客戶開票方式）
│     ├─ 淨額開一張（預設）：
│     │     小計 = 淨額
│     │     稅額 = 小計 × 5%
│     │     總額 = 小計 + 稅額
│     └─ 應收應付分開：
│           應收小計 → 應收稅額(5%) → 應收總額
│           應付小計 → 應付稅額(5%) → 應付總額
│
└─ 6. 產出月結明細（draft 狀態）
```

### 按趟結算客戶（特殊流程）

```
每趟完成時：
├─ 計算該趟 trip_items 金額
├─ 加上車趟費（如按次收取）
├─ 加上 frequency=per_trip 的附加費用
├─ 直接產出單趟明細（draft 狀態）
└─ 獨立審核和寄送，不走月結流程
```

> **按趟結算客戶的月度附加費用限制**：按趟結算客戶（`statement_type=per_trip`）的附加費用只允許設定 `frequency=per_trip`。UI 建立附加費用時，若客戶為按趟結算，`frequency` 鎖定為 `per_trip`，不可選 `monthly`。避免月度費用無處歸屬的邏輯漏洞。

### 計價邏輯差異

| | 簽約客戶 | 臨時客戶 |
|--|---------|---------|
| 品項來源 | 合約品項清單 | 品項主檔（選擇） |
| 單價來源 | 合約約定價（自動帶入） | 當次報價（手動輸入） |
| 費用方向 | 合約約定（自動帶入） | 當次約定（手動選擇） |
| 記錄方式 | trip_items 快照合約價 | trip_items 直接記錄報價 |

### 合約到期處理

當簽約客戶的有效合約全部到期（`status=expired`）且尚未建立新合約時：
- 建立車趟品項時，系統**無法自動帶入合約價**
- 此時改為**手動輸入模式**（等同臨時客戶），要求使用者手動輸入單價和方向
- UI 提示：「此客戶目前無有效合約，請手動輸入單價和費用方向」
- 不阻止建立車趟品項，確保業務不中斷

---

## 7. 自動化排程

### 排程任務

| 排程 | 時間 | 功能 |
|------|------|------|
| **月結明細產出** | 每月 5 號 09:00（遇假日提前） | 自動計算所有月結客戶上月明細，產出草稿 |
| **明細寄送檢查** | 每日 09:00 | 檢查當天是否有客戶到了寄送日，自動寄送已審核的明細 |
| **合約到期掃描** | 每日 10:00 | 30/15/7 天到期提醒 |
| **通知重試** | 每日 09:00 | 自動重試寄送失敗的通知 |

### 例假日調整邏輯

```
getWorkday(targetDate):
  while targetDate 是週六日或國定假日:
    targetDate = targetDate - 1 天
  return targetDate
```

- 假日包含：週六日 + 台灣國定假日
- 國定假日透過系統設定頁面手動維護
- 預留 API 接口，未來可接政府開放資料自動更新

### 月結明細狀態流轉

```
需開票：draft（草稿）→ approved（已審核）→ invoiced（已開票）→ sent（已寄送）
不需開票：draft（草稿）→ approved（已審核）→ sent（已寄送）
退回：   approved ↓→ rejected（退回）→ draft（修正後重新提交）→ approved
```

### 自動化時間線

```
每月 1-4 號              5 號                 5號之後            各客戶寄送日
┌──────────┐      ┌──────────────┐    ┌───────────────┐   ┌──────────────┐
│ 資料補齊期 │ ──→ │ 系統自動產出  │ ──→│  人工審核期    │──→│ 依客戶設定   │
│ 補登/修正  │      │ 全部客戶明細  │    │  確認/修正     │   │ 自動寄送     │
│ 上月車趟   │      │ (草稿狀態)   │    │  逐筆核准     │   │ (每日檢查)  │
└──────────┘      └──────────────┘    └───────────────┘   └──────────────┘
```

---

---

## 9. 報表輸出格式

### 客戶月結明細 PDF

```
┌──────────────────────────────────────────────┐
│  [公司LOGO]  XX環保資源回收有限公司              │
│                                              │
│  客戶名稱：大明企業        結算月份：2026年1月   │
│  合約編號：C-2026-001                         │
├──────────────────────────────────────────────┤
│                                              │
│  收運明細                                     │
│  日期    │品項  │數量│單位│單價│費用方向│金額   │
│  01/05  │總紙  │200│kg │3.5│ 應付  │  700  │
│  01/05  │PET   │100│kg │2.0│ 應收  │  200  │
│  01/12  │總紙  │300│kg │3.5│ 應付  │1,050  │
│  01/20  │PET   │150│kg │2.0│ 應收  │  300  │
│                                              │
│  車趟費：5趟 × 500元 = 2,500                  │
│                                              │
│  附加費用                                     │
│  處理費（按月）       │ 應收  │  1,000         │
│  環保補貼（按月）     │ 應付  │    300         │
│                                              │
│  ※ 只有應收或只有應付時，不顯示淨額             │
│  應收合計：    4,000                           │
│  （品項應收 500 + 車趟費 2,500 + 處理費 1,000） │
│  應付合計：    2,050                           │
│  （品項應付 1,750 + 環保補貼 300）              │
│  淨額：       1,950                           │
│  稅額(5%)：      98                           │
│  總額：       2,048                           │
│                                              │
│  → 客戶應付我方 2,048 元                       │
│                                              │
│  匯款帳戶：台北富邦 012-xxxxx                   │
├──────────────────────────────────────────────┤
│  製表日期：2026/02/05                          │
└──────────────────────────────────────────────┘
```

### 站區彙總報表 Excel

#### 工作表一：客戶總額

```
XX站區 - 2026年1月 客戶彙總

| 客戶名稱 | 類型 | 應收 | 應付 | 車趟費 | 附加費用 | 淨額 | 稅額 | 總額 |
|---------|------|------|------|-------|---------|------|------|------|
| 大明企業 | 簽約 | 3,200| 700  | 2,500 | +700   | 5,700| 285  | 5,985|
| 小華工廠 | 簽約 | 8,000| 0    | 1,600 | 0      | 9,600| 480  |10,080|
| 王先生   | 臨時 | 500  | 0    | 500   | 0      | 1,000| 50   | 1,050|
|---------|------|------|------|-------|---------|------|------|------|
| 合計     |     |11,700| 700  | 4,600 | +700   |16,300| 815  |17,115|
```

#### 工作表二：品項彙總

```
XX站區 - 2026年1月 品項彙總

| 編號 | 品項 | 單位 | 總數量 | 應收金額 | 應付金額 | 淨額 |
|------|------|------|-------|---------|---------|------|
| 1   | 總紙  | kg  | 5,000 | 0       | 17,500  |-17,500|
| 2   | PET   | kg  | 2,000 | 4,000   | 0       | 4,000|
| 3   | 總鐵  | kg  | 3,000 | 0       | 24,000  |-24,000|
| 5   | 紅銅燒| kg  | 50    | 2,500   | 0       | 2,500|
|------|------|------|-------|---------|---------|------|
| 合計  |     |      |       | 6,500   | 41,500  |-35,000|
```

---

## 10. UI 佈局

### 整體佈局

```
┌─────────────────────────────────────────────────────┐
│  LOGO   回收業務自動化系統          [通知🔔] [使用者▼] │
├────────────┬────────────────────────────────────────┤
│            │                                        │
│  儀表板    │         主要內容區                      │
│            │                                        │
│  基礎資料 ▼ │                                        │
│  • 站區管理 │                                        │
│  • 品項管理 │                                        │
│  • 客戶管理 │                                        │
│  • 合約管理 │                                        │
│            │                                        │
│  營運管理 ▼ │                                        │
│  • 車趟管理 │                                        │
│  • 外部同步 │                                        │
│            │                                        │
│  帳務管理 ▼ │                                        │
│  • 月結管理 │                                        │
│  • 報表     │                                        │
│            │                                        │
│  系統 ▼    │                                        │
│  • 使用者   │                                        │
│  • 假日設定 │                                        │
│  • 排程管理 │                                        │
│            │                                        │
└────────────┴────────────────────────────────────────┘
```

### 儀表板頁面

```
┌─────────────────────────────────────────────────────┐
│  儀表板                              2026年2月       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │ 本月車趟  │ │ 應收總額  │ │ 應付總額  │ │ 客戶數 │ │
│  │    42    │ │  85,000  │ │  32,000  │ │  156  │ │
│  └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│                                                     │
│  待處理事項                                          │
│  ┌─────────────────────────────────────────────┐    │
│  │ 待審核明細          12 筆    [前往審核]       │    │
│  │ 合約即將到期(30天內)  3 筆    [前往查看]       │    │
│  │ 寄送失敗待重試        2 筆    [前往處理]       │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
│  合約到期提醒                                        │
│  ┌─────────────────────────────────────────────┐    │
│  │ 客戶名稱  │合約編號    │到期日    │剩餘天數   │    │
│  │ 大明企業  │C-2026-001│2026/03/01│ 19天     │    │
│  │ 小華工廠  │C-2026-005│2026/02/28│ 18天     │    │
│  │ 李氏公司  │C-2026-012│2026/03/15│ 33天     │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 客戶管理頁面

```
┌──────────────────────────────────────────────────┐
│  客戶管理                        [+ 新增客戶]     │
├──────────────────────────────────────────────────┤
│  [搜尋客戶名稱...]  站區[▼全部]  類型[▼全部]      │
├──────────────────────────────────────────────────┤
│  客戶名稱    │站區│類型 │車趟費│明細  │付款  │操作   │
│─────────────┼───┼────┼────┼─────┼─────┼─────│
│  大明企業    │北區│簽約 │按次  │月結  │一次付│[編輯] │
│  小華工廠    │南區│簽約 │按月  │按趟  │按趟付│[編輯] │
│  臨時王先生  │北區│臨時 │按次  │按趟  │按趟付│[編輯] │
│  李氏公司    │北區│簽約 │按次  │月結  │按趟付│[編輯] │
└──────────────────────────────────────────────────┘
```

### 客戶附加費用管理（客戶編輯頁內的子區塊）

```
┌──────────────────────────────────────────────────┐
│  附加費用                          [+ 新增費用]    │
├──────────────────────────────────────────────────┤
│  費用名稱    │金額(元)│費用方向│頻率  │狀態│操作    │
│─────────────┼──────┼──────┼─────┼───┼──────│
│  處理費      │ 1,000│ 應收  │按月 │啟用│[編輯] │
│  環保補貼    │   300│ 應付  │按月 │啟用│[編輯] │
│  臨時加收費  │   200│ 應收  │按趟 │啟用│[編輯] │
└──────────────────────────────────────────────────┘
```

> 費用名稱自由輸入，金額為固定金額，方向和頻率各自設定。

### 合約管理頁面（品項層級計費）

```
┌──────────────────────────────────────────────────┐
│  ← 大明企業 - 合約管理              [+ 新增合約]   │
├──────────────────────────────────────────────────┤
│  合約編號: C-2026-001                             │
│  期間: 2026/01/01 ~ 2026/12/31    狀態: ●有效     │
├──────────────────────────────────────────────────┤
│  合約品項                          [+ 新增品項]    │
│  ┌──────────────────────────────────────────────┐│
│  │編號│品項名稱  │單位│單價(元)│費用方向│操作  ││
│  │───┼────────┼───┼──────┼──────┼─────││
│  │ 1 │總紙     │ kg │  3.5  │ 應付  │[編輯]││
│  │ 2 │總鐵     │ kg │  8.0  │ 應付  │[編輯]││
│  │ 3 │PET      │ kg │  2.0  │ 應收  │[編輯]││
│  │ 4 │紅銅燒   │ kg │ 15.0  │ 應收  │[編輯]││
│  │ 5 │大鐵桶   │ kg │ 50.0  │ 應收  │[編輯]││
│  └──────────────────────────────────────────────┘│
└──────────────────────────────────────────────────┘
```

### 月結管理頁面

```
┌──────────────────────────────────────────────────────┐
│  月結管理  2026年1月          [▼選擇月份] [重新產出]   │
├──────────────────────────────────────────────────────┤
│  待審核(12)  已審核(5)  已寄送(30)  退回(2)           │
├──────────────────────────────────────────────────────┤
│  客戶名稱  │站區│應收    │應付    │淨額     │狀態│操作│
│───────────┼───┼───────┼───────┼────────┼───┼───│
│  大明企業  │北區│ 1,200 │ 3,500 │-2,300付│草稿│[審]│
│  小華工廠  │南區│ 8,000 │     0 │ 8,000收│草稿│[審]│
│───────────┴───┴───────┴───────┴────────┴───┴───│
│                               [全部審核通過] [匯出]  │
└──────────────────────────────────────────────────────┘

審核詳情展開：
┌──────────────────────────────────────────────────┐
│  大明企業 - 2026年1月明細                          │
│                                                  │
│  品項明細                                         │
│  日期    │品項    │數量│單位│單價 │方向│金額        │
│  01/05  │總紙    │ 200│ kg │3.5 │應付│  -700      │
│  01/05  │PET     │ 100│ kg │2.0 │應收│  +200      │
│  01/12  │總紙    │ 300│ kg │3.5 │應付│ -1,050     │
│  ...                                             │
│                                                  │
│  車趟費：5趟 × 500元 = +2,500（應收）              │
│                                                  │
│  彙總：應收 1,200 - 應付 3,500 = 淨額 -2,300      │
│  小計：2,300  稅額(5%)：115  總額：2,415           │
│       → 我方需付客戶 2,415 元                      │
│                                                  │
│           [退回修正]  [審核通過]                    │
└──────────────────────────────────────────────────┘
```

### 響應式設計（RWD）

#### 斷點定義（基於 Ant Design 5 Grid）

| 斷點 | 寬度範圍 | 裝置類型 | 主要使用情境 |
|------|---------|---------|------------|
| `xs` | < 576px | 手機 | 外勤人員查看車趟、快速審核 |
| `sm` | ≥ 576px | 大手機/小平板 | 簡易操作、通知確認 |
| `md` | ≥ 768px | 平板（直向） | 現場管理、車趟登錄 |
| `lg` | ≥ 992px | 平板（橫向）/小筆電 | 日常管理作業 |
| `xl` | ≥ 1200px | 桌上電腦 | 主要辦公作業（預設設計基準） |
| `xxl` | ≥ 1600px | 大螢幕 | 儀表板全覽 |

#### 佈局響應行為

```
桌面 (≥992px)                    平板 (768~991px)               手機 (<768px)
┌────────┬──────────┐     ┌──────────────────┐     ┌──────────────────┐
│        │          │     │ ☰ 系統名稱  🔔 👤 │     │ ☰ 系統名稱  🔔 👤│
│ 側邊欄  │ 主內容區  │     ├──────────────────┤     ├──────────────────┤
│ 展開    │          │     │                  │     │                  │
│ 240px  │ 自動填滿  │     │   主內容區         │     │   主內容區        │
│        │          │     │   （全寬）          │     │   （全寬）         │
│        │          │     │                  │     │                  │
│        │          │     │                  │     ├──────────────────┤
│        │          │     │                  │     │ [底部操作列]      │
└────────┴──────────┘     └──────────────────┘     └──────────────────┘
  側邊欄固定展開              側邊欄收合為圖示列          側邊欄隱藏為抽屜
  Sider collapsed=false     Sider collapsed=true     Drawer 點擊 ☰ 展開
```

#### 元件響應規則

**1. 側邊欄（AppLayout.tsx）**

| 斷點 | 行為 | Ant Design 實作 |
|------|------|----------------|
| ≥ 992px | 固定展開，寬度 240px | `<Sider collapsed={false} width={240}>` |
| 768 ~ 991px | 收合為圖示列，寬度 80px，hover 展開 | `<Sider collapsed={true} collapsedWidth={80}>` |
| < 768px | 隱藏側邊欄，漢堡選單開啟 Drawer | `<Drawer placement="left">` |

**2. 儀表板統計卡片**

```
桌面 (≥1200px): 4 欄並排
┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐
│本月車趟│ │應收總額│ │應付總額│ │ 客戶數│
└──────┘ └──────┘ └──────┘ └──────┘

平板 (768~1199px): 2 欄 × 2 列
┌──────┐ ┌──────┐
│本月車趟│ │應收總額│
├──────┤ ├──────┤
│應付總額│ │ 客戶數│
└──────┘ └──────┘

手機 (<768px): 水平捲動或 1 欄
┌──────┐ ┌──────┐ ►
│本月車趟│ │應收總額│ ...
└──────┘ └──────┘
```

Ant Design 實作：`<Row gutter={[16, 16]}><Col xs={12} sm={12} md={12} lg={6}>...`

**3. 資料表格**

| 斷點 | 行為 |
|------|------|
| ≥ 992px | 完整表格，所有欄位顯示 |
| 768 ~ 991px | 隱藏次要欄位（如「操作」改為更多選單），表格水平捲動 |
| < 768px | 切換為卡片列表模式 |

```
桌面表格模式:
│ 客戶名稱 │站區│類型│車趟費│明細│付款│操作  │

手機卡片模式:
┌────────────────────────┐
│ 大明企業           [⋯]  │
│ 北區 ∙ 簽約              │
│ 車趟費:按次 ∙ 月結 ∙ 一次付│
├────────────────────────┤
│ 小華工廠           [⋯]  │
│ 南區 ∙ 簽約              │
│ 車趟費:按月 ∙ 按趟 ∙ 按趟付│
└────────────────────────┘
```

實作策略：使用 `useBreakpoint()` hook 偵測斷點，條件渲染 `<Table>` 或 `<List>`。

**4. 表單**

| 斷點 | 行為 |
|------|------|
| ≥ 992px | 雙欄表單佈局 `<Col span={12}>` |
| < 992px | 單欄全寬佈局 `<Col span={24}>` |

**5. 操作按鈕**

| 斷點 | 行為 |
|------|------|
| ≥ 768px | 按鈕在頁面標題列右側 |
| < 768px | 主要操作固定在螢幕底部（`position: fixed; bottom: 0`），次要操作收進更多選單 |

**6. 月結審核詳情**

| 斷點 | 行為 |
|------|------|
| ≥ 992px | 展開行內（expandedRowRender）顯示明細表格 |
| < 992px | 點擊進入獨立全頁明細頁面 |

#### 響應式工具 Hook

```typescript
// frontend/src/hooks/useResponsive.ts
import { Grid } from 'antd'

const { useBreakpoint } = Grid

export function useResponsive() {
  const screens = useBreakpoint()
  return {
    isMobile: !screens.md,       // < 768px
    isTablet: screens.md && !screens.lg,  // 768 ~ 991px
    isDesktop: !!screens.lg,     // ≥ 992px
  }
}
```

#### 觸控優化（平板 / 手機）

| 項目 | 規則 |
|------|------|
| 點擊目標 | 最小 44×44px（符合 WCAG 2.5.5） |
| 表格行高 | 手機模式下行高 ≥ 48px |
| 間距 | 手機模式下 padding 加大至 16px |
| 手勢 | 側邊欄支援右滑關閉（Drawer swipe） |

---

## 11. 修改檔案清單

全部重寫，以下為完整檔案結構：

### 後端

| 檔案路徑 | 說明 |
|---------|------|
| `backend/prisma/schema.prisma` | 重寫資料模型（含 Mock DB 資料表） |
| `backend/prisma/seed.ts` | 重寫種子資料（含 Mock 假資料） |
| `backend/src/index.ts` | 入口點 |
| `backend/src/app.ts` | Express 設定 |
| **Adapter 層** | |
| `backend/src/adapters/index.ts` | Adapter 工廠函數（依環境變數切換 Mock/Real） |
| `backend/src/adapters/pos.adapter.ts` | IPosAdapter 介面定義 |
| `backend/src/adapters/vehicle.adapter.ts` | IVehicleAdapter 介面定義 |
| `backend/src/adapters/types.ts` | Adapter 共用型別（PosCollectionRecord、VehicleTripRecord 等） |
| `backend/src/adapters/mock/mock-pos.adapter.ts` | Mock POS 實作（讀寫 mock_pos_collections） |
| `backend/src/adapters/mock/mock-vehicle.adapter.ts` | Mock 車機實作（讀寫 mock_vehicle_trips） |
| `backend/src/adapters/mock/mock-data-seeder.ts` | Mock 假資料產生器 |
| `backend/src/adapters/real/real-pos.adapter.ts` | 真實 POS API 實作（未來） |
| `backend/src/adapters/real/real-vehicle.adapter.ts` | 真實車機 API 實作（未來） |
| **Routes** | |
| `backend/src/routes/dashboard.ts` | 儀表板統計 API |
| `backend/src/routes/auth.ts` | 認證 API |
| `backend/src/routes/sites.ts` | 站區 CRUD |
| `backend/src/routes/items.ts` | 品項 CRUD |
| `backend/src/routes/customers.ts` | 客戶 CRUD + 客戶附加費用 CRUD |
| `backend/src/routes/contracts.ts` | 合約 + 合約品項 CRUD |
| `backend/src/routes/trips.ts` | 車趟 + 趟次品項 CRUD |
| `backend/src/routes/statements.ts` | 月結明細 + 審核 + 寄送 |
| `backend/src/routes/reports.ts` | 報表產出 |
| `backend/src/routes/schedule.ts` | 排程管理 |
| `backend/src/routes/users.ts` | 使用者管理 |
| `backend/src/routes/holidays.ts` | 假日管理 |
| `backend/src/routes/sync.ts` | 外部系統同步 API（POS/車機資料拉取+推送） |
| **Services** | |
| `backend/src/services/billing.service.ts` | 計費引擎 |
| `backend/src/services/statement.service.ts` | 月結明細產出 |
| `backend/src/services/pdf-generator.ts` | PDF 產出 |
| `backend/src/services/notification.service.ts` | Email 寄送（LINE 預留接口） |
| `backend/src/services/scheduler.service.ts` | 排程服務 |
| `backend/src/services/holiday.service.ts` | 假日判斷 |
| `backend/src/services/sync.service.ts` | 外部系統同步服務（呼叫 Adapter 進行資料同步） |
| **Middleware** | |
| `backend/src/middleware/auth.ts` | JWT 驗證中介層 |

### 前端

| 檔案路徑 | 說明 |
|---------|------|
| `frontend/src/App.tsx` | 路由設定 |
| `frontend/src/components/AppLayout.tsx` | 響應式側邊欄 + 頂部欄佈局（Sider/Drawer 切換） |
| `frontend/src/hooks/useResponsive.ts` | 響應式斷點 Hook（isMobile/isTablet/isDesktop） |
| `frontend/src/pages/LoginPage.tsx` | 登入頁 |
| `frontend/src/pages/DashboardPage.tsx` | 儀表板 |
| `frontend/src/pages/SitesPage.tsx` | 站區管理 |
| `frontend/src/pages/ItemsPage.tsx` | 品項管理 |
| `frontend/src/pages/CustomersPage.tsx` | 客戶管理 |
| `frontend/src/pages/ContractsPage.tsx` | 合約管理 + 合約品項 |
| `frontend/src/pages/TripsPage.tsx` | 車趟管理 + 品項明細 |
| `frontend/src/pages/SyncPage.tsx` | 外部系統同步（手動觸發同步、同步結果、比對失敗紀錄） |
| `frontend/src/pages/StatementsPage.tsx` | 月結管理 + 審核 |
| `frontend/src/pages/ReportsPage.tsx` | 報表 |
| `frontend/src/pages/HolidaysPage.tsx` | 假日設定 |
| `frontend/src/pages/SchedulePage.tsx` | 排程管理 |
| `frontend/src/pages/UsersPage.tsx` | 使用者管理 |

### API 路由總覽

| 模組 | 路由 | 方法 | 說明 |
|------|------|------|------|
| 認證 | /api/auth/login | POST | 登入 |
| 認證 | /api/auth/me | GET | 取得當前使用者 |
| 儀表板 | /api/dashboard/stats | GET | 彙總統計（本月車趟數、應收/應付總額、客戶數、待審核數、合約到期提醒） |
| 站區 | /api/sites | GET/POST | 列表 / 新增 |
| 站區 | /api/sites/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 品項 | /api/items | GET/POST | 列表 / 新增 |
| 品項 | /api/items/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 客戶 | /api/customers | GET/POST | 列表 / 新增 |
| 客戶 | /api/customers/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 合約 | /api/contracts | GET/POST | 列表 / 新增 |
| 合約 | /api/contracts/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 合約品項 | /api/contracts/:id/items | GET/POST | 列表 / 新增 |
| 合約品項 | /api/contracts/:cid/items/:iid | PATCH/DELETE | 更新 / 刪除 |
| 車趟 | /api/trips | GET/POST | 列表 / 新增 |
| 車趟 | /api/trips/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 車趟品項 | /api/trips/:id/items | GET/POST | 列表 / 新增 |
| 車趟品項 | /api/trips/:tid/items/:iid | PATCH/DELETE | 更新 / 刪除 |
| 月結 | /api/statements | GET | 月結明細列表 |
| 月結 | /api/statements/generate | POST | 手動觸發產出 |
| 月結 | /api/statements/:id | GET | 明細詳情 |
| 月結 | /api/statements/:id/review | PATCH | 審核（通過/退回） |
| 月結 | /api/statements/:id/invoice | PATCH | 標記已開票 |
| 月結 | /api/statements/:id/send | POST | 寄送 |
| 報表 | /api/reports/customers/:customerId | GET | 客戶明細 PDF（`?yearMonth=2026-01`） |
| 報表 | /api/reports/sites/:siteId | GET | 站區彙總 Excel（`?yearMonth=2026-01`） |
| 排程 | /api/schedule | GET | 排程狀態 |
| 排程 | /api/schedule/:name/trigger | POST | 手動觸發 |
| 假日 | /api/holidays | GET/POST | 列表 / 新增 |
| 假日 | /api/holidays/:id | DELETE | 刪除 |
| 假日 | /api/holidays/import | POST | 批次匯入（JSON 陣列：`[{date, name, year}]`） |
| 使用者 | /api/users | GET/POST | 列表 / 新增 |
| 使用者 | /api/users/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 客戶附加費用 | /api/customers/:id/fees | GET/POST | 列表 / 新增 |
| 客戶附加費用 | /api/customers/:cid/fees/:fid | PATCH/DELETE | 更新 / 刪除 |
| **外部系統同步** | | | |
| 同步 | /api/sync/pos/pull | POST | 從 POS 拉取收運紀錄 |
| 同步 | /api/sync/pos/push-customers | POST | 推送客戶資料到 POS |
| 同步 | /api/sync/pos/push-prices | POST | 推送合約品項定價到 POS |
| 同步 | /api/sync/vehicle/pull | POST | 從車機拉取車趟紀錄 |
| 同步 | /api/sync/vehicle/push-customers | POST | 推送客戶資料到車機 |
| 同步 | /api/sync/vehicle/dispatch | POST | 發送派車指令到車機 |
| 同步 | /api/sync/vehicle/status | GET | 取得車輛即時狀態 |
| 同步 | /api/sync/status | GET | 查看各 Adapter 的連線模式和狀態 |

---

## 12. 驗收標準

### 基礎資料
- [ ] 站區 CRUD 正常運作
- [ ] 品項主檔 CRUD 正常運作（編號流水號、名稱唯一、可設定單位）
- [ ] 客戶建立時可設定車趟費（收/不收、按次/按月、金額）
- [ ] 客戶建立時可設定明細產出方式（月結/按趟）和付款方式（一次付清/按趟分付）
- [ ] 客戶建立時可設定通知方式和匯款帳戶
- [ ] 客戶附加費用 CRUD 正常運作（自由輸入名稱、固定金額、各自設定方向和頻率）

### 合約與計費
- [ ] 合約 CRUD 正常運作（含期限管理）
- [ ] 合約品項可個別設定單價與費用方向（應收/應付/免費）
- [ ] 同一客戶不同品項可有不同費用方向

### 車趟與品項
- [ ] 車趟紀錄 CRUD 正常運作
- [ ] 簽約客戶建立車趟品項時，自動帶入合約價格和方向快照
- [ ] 臨時客戶建立車趟品項時，可手動輸入報價和方向
- [ ] 車趟紀錄正確記錄資料來源（manual / pos_sync / vehicle_sync）

### 月結流程
- [ ] 計費引擎正確計算應收/應付/車趟費/附加費用/淨額/小計/稅額(5%)/總額
- [ ] 開票方式支援淨額一張和應收應付分開兩種模式
- [ ] 月結明細自動產出（5 號，遇假日提前至前一工作日）
- [ ] 審核流程正常（草稿→審核通過→已開票→已寄送，或草稿→審核通過→已寄送）
- [ ] 退回流程正常（審核通過→退回→修正後重新提交→審核通過）
- [ ] 已審核明細依各客戶寄送日自動寄送 Email（預設 15 號，遇假日提前）
- [ ] 按趟明細客戶可獨立產出單趟明細
- [ ] 月結明細 + 按趟分次付款的客戶，明細整月一份但付款拆趟次
- [ ] 按趟明細客戶不允許設定「按趟分次付款」（等同一次付清，UI 鎖定）

### 報表
- [ ] 客戶月結明細 PDF 正確產出（只有應收或應付時不顯示淨額）
- [ ] 站區彙總報表 Excel 正確產出（客戶總額 + 品項彙總兩個工作表）
- [ ] 不需開發票的客戶也能產出明細

### 系統管理
- [ ] 國定假日管理（新增/刪除/批次匯入）
- [ ] 假日調整邏輯正確（週六日 + 國定假日往前推）
- [ ] 合約到期提醒（30/15/7 天）
- [ ] 通知重試（寄送失敗自動重試）
- [ ] 排程可查看狀態和手動觸發

### 響應式設計（RWD）
- [ ] 側邊欄三段式響應：桌面展開(≥992px) / 平板收合(768~991px) / 手機 Drawer(<768px)
- [ ] 儀表板卡片響應排列（4→2→1 欄）
- [ ] 資料表格手機模式切換為卡片列表
- [ ] 表單桌面雙欄 / 行動單欄自動切換
- [ ] 操作按鈕手機模式固定底部
- [ ] 觸控目標 ≥ 44×44px
- [ ] useResponsive Hook 在所有頁面正確運作

### 外部系統整合（Adapter）
- [ ] IPosAdapter 介面定義完整（讀取收運紀錄、同步客戶、同步合約定價）
- [ ] IVehicleAdapter 介面定義完整（讀取車趟紀錄、車輛狀態、同步客戶、派車）
- [ ] MockPosAdapter 正常讀寫 mock_pos_collections 資料表
- [ ] MockVehicleAdapter 正常讀寫 mock_vehicle_trips 資料表
- [ ] Mock 假資料產生器可批量產生測試資料
- [ ] 環境變數切換 Mock/Real 模式正常運作
- [ ] 同步 API 路由正常運作（pull/push）
- [ ] Adapter 健康檢查（healthCheck）正確回報連線狀態
- [ ] 同步排程執行前自動檢查 Adapter 狀態，連線失敗時跳過並通知
- [ ] Adapter 狀態查詢 API 正確顯示當前模式和連線狀態

---

## 13. MVP 不做清單（未來擴充）

| 項目 | 預計時機 | 備註 |
|------|---------|------|
| 權限分離（總部/站區） | 穩定運作後 | |
| LINE 通知 | 申請 Bot 後 | notification.service 已預留接口 |
| **POS 真實 API 接入** | 確認 POS API 規格後 | 實作 RealPosAdapter，環境變數切換即可 |
| **車機真實 API 接入** | 確認車機 API 規格後 | 實作 RealVehicleAdapter，環境變數切換即可 |
| ERP 接入 | 確認 API 規格後 | 可新增 IErpAdapter |
| 報價審核流程 | 需求明確後 | |
| 車趟排程預排 | 需求明確後 | |
| 政府假日 API 自動更新 | 找到穩定資料源後 | |
| 月結全自動（跳過審核） | 計算正確性確認後 | |
| 自動化資料同步排程 | Adapter 穩定後 | 定時自動拉取 POS/車機資料 |
