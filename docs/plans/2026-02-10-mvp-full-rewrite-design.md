# 回收業務自動化系統 — MVP 全面重寫設計

> 日期：2026-02-10
> 狀態：設計完成，待實作
> 策略：全部重寫，保留技術選型（React + Express + Prisma + PostgreSQL）

---

## 1. 問題描述 / 概述

現有系統的業務模型與實際營運有落差（例如 A/B/C/D 計費分類無法反映品項層級的計費方向差異），需要基於正確的業務理解全面重寫。

### MVP 原則

- 所有資料來源為手動輸入 + Excel 匯入（不接車機/ERP 等外部系統）
- 通知寄送：Email 先做，LINE 預留接口後補
- 權限分離：不做，所有使用者同等權限
- 審核流程：人工審核，穩定後再改自動
- 報價簽約流程：不做（系統外處理），只管理已簽約的合約
- 車趟排程預排：不做
- 假日資料：系統內手動維護
- 架構預留擴充性，方便後續接入外部系統

---

## 2. 業務模型

### 核心業務

公司經營 7 個站區（未來可能增減），向配合客戶收取回收物。

### 客戶分類

| 類型 | 說明 | 計價方式 |
|------|------|---------|
| **簽約客戶** | 正式簽約，有合約品項定價 | 依合約品項單價和方向 |
| **臨時客戶** | 臨時叫車收運，事先報價後派車 | 每次單獨報價，手動輸入 |

兩者都要在系統中管理。

### 報價簽約流程（系統外處理）

```
客戶詢價 → 站區主任擬報價 → 總部審核通過 → 寄送報價單 → 簽約
```

> MVP 不做此流程，系統僅管理已簽約的合約資料。

### 計費特性（高度客製化）

- **品項層級**：每個品項各自設定單價和費用方向
- **費用方向**：應收（客戶付我方）/ 應付（我方付客戶）/ 不收費
- **同一客戶不同品項可有不同方向**（例如廢紙應付、廢棄物處理應收）
- **車趟費**：我方向客戶收取，按次或按月計算
- **明細產出**：月結（整月一份）/ 按趟（每趟一份），與簽約/臨時類型獨立設定
- **付款方式**：一次付清 / 按趟分次付款（依客戶需求）
- **發票**：需要開立 / 不需要開立（明細一律都會產出）
- **開票方式**：淨額開一張（預設）/ 應收應付分開（依客戶需求，僅需開票的客戶適用）
- **稅額**：5% 營業稅
- **發票寄送**：Email（MVP），LINE（後補）

---

## 3. 需求清單

### 基礎資料管理
1. 站區 CRUD
2. 公司統一品項清單 CRUD
3. 客戶 CRUD（含車趟費設定、結算方式、通知偏好、匯款帳戶）
4. 合約 CRUD（含期限管理）
5. 合約品項 CRUD（品項 + 單價 + 費用方向）

### 日常營運
6. 車趟紀錄建立（手動）
7. 車趟品項明細（簽約客戶自動帶入合約價快照，臨時客戶手動輸入）
8. Excel 批次匯入車趟 + 品項
9. 車趟/品項資料修正

### 月結與發票
10. 每月 5 號自動產出全部月結客戶明細（草稿狀態）
11. 人工審核流程（審核通過 / 退回修正）
12. 每月 15 號自動寄送已審核明細（Email）
13. 按趟結算客戶：每趟完成時獨立產出明細
14. 遇假日（週六日 + 國定假日）提前至前一個工作日

### 報表
15. 客戶月結明細 PDF
16. 站區彙總報表 Excel

### 系統管理
17. 使用者管理（不分權限）
18. 國定假日管理
19. 排程狀態查詢 + 手動觸發
20. 合約到期提醒（30/15/7 天）
21. 通知重試（寄送失敗自動重試）

---

## 4. 資料模型

### ER 關係圖

```
┌─────────────┐     ┌──────────────┐     ┌────────────────┐
│   sites     │     │  customers   │     │   contracts    │
│ 站區主檔     │←───│  客戶主檔     │←───│   合約         │
└─────────────┘     └──────────────┘     └───────┬────────┘
                                                  │
┌─────────────┐                          ┌────────▼────────┐
│   items     │                          │ contract_items   │
│ 品項主檔     │←────────────────────────│ 合約品項(核心!)   │
└──────┬──────┘                          └─────────────────┘
       │
       │ 被引用於
       ▼
┌──────────────┐     ┌────────────────┐
│    trips     │←───│  trip_items    │
│ 車趟紀錄      │     │ 趟次品項明細   │
└──────────────┘     └────────────────┘

┌────────────────────┐
│ monthly_statements │
│ 月結明細            │
└────────────────────┘

┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│   users      │  │  holidays    │  │  system_logs │
│  使用者       │  │  假日主檔     │  │  系統日誌     │
└──────────────┘  └──────────────┘  └──────────────┘
```

### 資料表定義

#### sites（站區主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| name | String | 站區名稱 |
| address | String? | 地址 |
| phone | String? | 聯絡電話 |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### items（品項主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增（流水號，即為品項編號） |
| code | Int (unique) | 品項編號（流水號 1, 2, 3...） |
| name | String (unique) | 品項名稱（全公司統一） |
| category | String? | 分類 |
| unit | String | 計量單位（kg、件、袋等） |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### customers（客戶主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| site_id | Int (FK) | 所屬站區 |
| name | String | 客戶名稱 |
| contact_person | String? | 聯絡人 |
| phone | String? | 電話 |
| address | String? | 地址 |
| type | Enum | contracted（簽約）/ temporary（臨時） |
| trip_fee_enabled | Boolean | 是否收車趟費 |
| trip_fee_type | Enum? | per_trip（按次）/ per_month（按月） |
| trip_fee_amount | Decimal? | 車趟費金額 |
| statement_type | Enum | monthly（整月一份明細）/ per_trip（每趟一份明細） |
| payment_type | Enum | lump_sum（一次付清）/ per_trip（按趟分次付款） |
| invoice_required | Boolean | 是否需要開立發票（明細一律產出） |
| invoice_type | Enum? | net（淨額開一張，預設）/ separate（應收應付分開），僅 invoice_required=true 時有效 |
| notification_method | Enum | email / line / both |
| notification_email | String? | 通知 Email |
| notification_line_id | String? | LINE ID（後補） |
| payment_account | String? | 匯款帳戶資訊 |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### contracts（合約）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK) | 所屬客戶 |
| contract_number | String (unique) | 合約編號 |
| start_date | Date | 合約起始日 |
| end_date | Date | 合約到期日 |
| status | Enum | draft / active / expired / terminated |
| notes | String? | 備註 |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### contract_items（合約品項 — 計費核心）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| contract_id | Int (FK) | 所屬合約 |
| item_id | Int (FK) | 品項（引用品項主檔） |
| unit_price | Decimal | 合約單價 |
| billing_direction | Enum | **receivable**（客戶付我方）/ **payable**（我方付客戶）/ **free**（不收費） |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### trips（車趟紀錄）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK) | 客戶 |
| site_id | Int (FK) | 站區 |
| trip_date | Date | 收運日期 |
| driver | String? | 司機 |
| vehicle_plate | String? | 車牌 |
| notes | String? | 備註 |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### trip_items（趟次品項明細）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| trip_id | Int (FK) | 所屬車趟 |
| item_id | Int (FK) | 品項（引用品項主檔） |
| quantity | Decimal | 數量（配合品項單位：kg、件、袋等） |
| unit | String | **快照**：收運當時的計量單位 |
| unit_price | Decimal | **快照**：收運當時的單價 |
| billing_direction | Enum | **快照**：收運當時的方向 |
| amount | Decimal | 計算金額（unit_price × quantity） |
| created_at | DateTime | 建立時間 |

> 快照設計：合約可能變動，但已收運的紀錄鎖定當時的單位、價格和方向。
> 簽約客戶 → 自動帶入合約價；臨時客戶 → 手動輸入報價。

#### monthly_statements（月結明細）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| customer_id | Int (FK) | 客戶 |
| year_month | String | 結算月份（如 2026-01） |
| total_receivable | Decimal | 應收合計（含車趟費） |
| total_payable | Decimal | 應付合計 |
| net_amount | Decimal | 淨額（正=應收，負=應付） |
| trip_fee_total | Decimal | 車趟費合計 |
| subtotal | Decimal | 小計（依開票方式計算） |
| tax_amount | Decimal | 稅額（5%） |
| total_amount | Decimal | 總額（小計 + 稅額） |
| detail_json | JSON | 完整明細（品項、車趟費等） |
| status | Enum | draft / approved / rejected / invoiced / sent |
| reviewed_by | Int? (FK) | 審核人 |
| reviewed_at | DateTime? | 審核時間 |
| sent_at | DateTime? | 寄送時間 |
| sent_method | Enum? | email / line |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### holidays（假日主檔）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| date | Date (unique) | 假日日期 |
| name | String | 假日名稱（如「春節」） |
| year | Int | 年份（方便查詢） |
| created_at | DateTime | 建立時間 |

#### users（使用者）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| username | String (unique) | 帳號 |
| password_hash | String | 密碼雜湊 |
| name | String | 姓名 |
| email | String? | Email |
| role | String | 角色（MVP 統一為 admin） |
| status | Enum | active / inactive |
| created_at | DateTime | 建立時間 |
| updated_at | DateTime | 更新時間 |

#### system_logs（系統日誌）

| 欄位 | 型別 | 說明 |
|------|------|------|
| id | Int (PK) | 自動遞增 |
| event_type | String | 事件類型 |
| event_content | String | 事件內容 |
| user_id | Int? (FK) | 操作使用者 |
| created_at | DateTime | 建立時間 |

---

## 5. 計費邏輯

### 計算單一客戶月結金額

```
計算月結（customer_id, year_month）
│
├─ 1. 查詢該客戶當月所有 trip_items（已快照單價和方向）
│
├─ 2. 依方向分組計算
│     ├─ 應收小計 = Σ(receivable 品項的 amount)
│     ├─ 應付小計 = Σ(payable 品項的 amount)
│     └─ free 品項不計金額
│
├─ 3. 車趟費計算
│     ├─ 不收 → 0
│     ├─ 按次 → 當月趟數 × 單次金額
│     └─ 按月 → 固定月費
│     （車趟費固定為應收）
│
├─ 4. 彙總
│     ├─ 應收合計 = 應收小計 + 車趟費
│     ├─ 應付合計 = 應付小計
│     └─ 淨額 = 應收合計 - 應付合計
│         正數 → 客戶付我方
│         負數 → 我方付客戶
│
├─ 5. 稅額計算（依客戶開票方式）
│     ├─ 淨額開一張（預設）：
│     │     小計 = 淨額
│     │     稅額 = 小計 × 5%
│     │     總額 = 小計 + 稅額
│     └─ 應收應付分開：
│           應收小計 → 應收稅額(5%) → 應收總額
│           應付小計 → 應付稅額(5%) → 應付總額
│
└─ 6. 產出月結明細（draft 狀態）
```

### 按趟結算客戶（特殊流程）

```
每趟完成時：
├─ 計算該趟 trip_items 金額
├─ 加上車趟費（如按次收取）
├─ 直接產出單趟明細（draft 狀態）
└─ 獨立審核和寄送，不走月結流程
```

### 計價邏輯差異

| | 簽約客戶 | 臨時客戶 |
|--|---------|---------|
| 品項來源 | 合約品項清單 | 品項主檔（選擇） |
| 單價來源 | 合約約定價（自動帶入） | 當次報價（手動輸入） |
| 費用方向 | 合約約定（自動帶入） | 當次約定（手動選擇） |
| 記錄方式 | trip_items 快照合約價 | trip_items 直接記錄報價 |

---

## 6. 自動化排程

### 排程任務

| 排程 | 時間 | 功能 |
|------|------|------|
| **月結明細產出** | 每月 5 號 09:00（遇假日提前） | 自動計算所有月結客戶上月明細，產出草稿 |
| **開票寄送** | 每月 15 號 09:00（遇假日提前） | 自動寄送所有「已審核」的明細（Email） |
| **合約到期掃描** | 每日 10:00 | 30/15/7 天到期提醒 |
| **通知重試** | 每日 09:00 | 自動重試寄送失敗的通知 |

### 例假日調整邏輯

```
getWorkday(targetDate):
  while targetDate 是週六日或國定假日:
    targetDate = targetDate - 1 天
  return targetDate
```

- 假日包含：週六日 + 台灣國定假日
- 國定假日透過系統設定頁面手動維護
- 預留 API 接口，未來可接政府開放資料自動更新

### 月結明細狀態流轉

```
draft（草稿）→ approved（已審核）→ invoiced（已開票）→ sent（已寄送）
                   ↓
              rejected（退回）→ 修正後重新提交 → approved
```

### 自動化時間線

```
每月 1-4 號              5 號                 5-14 號            15 號
┌──────────┐      ┌──────────────┐    ┌───────────────┐   ┌──────────────┐
│ 資料補齊期 │ ──→ │ 系統自動產出  │ ──→│  人工審核期    │──→│ 自動寄送     │
│ 補登/修正  │      │ 全部客戶明細  │    │  確認/修正     │   │ Email       │
│ 上月車趟   │      │ (草稿狀態)   │    │  逐筆核准     │   │             │
└──────────┘      └──────────────┘    └───────────────┘   └──────────────┘
```

---

## 7. Excel 匯入格式

系統提供標準範本讓行政下載填寫，之後取得實際 Excel 格式再調整解析。

### 車趟匯入範本

```
| 收運日期 | 客戶名稱 | 司機 | 車牌 | 品項 | 數量 | 單位 | 單價 | 費用方向 |
|---------|---------|------|------|------|------|------|------|---------|
| 2026/01/05 | 大明企業 | 王大明 | ABC-1234 | 廢紙 | 200 | kg | 3.5 | 應付 |
| 2026/01/05 | 大明企業 | 王大明 | ABC-1234 | 廢塑膠 | 100 | kg | 2.0 | 應收 |
| 2026/01/05 | 小華工廠 | 李小華 | DEF-5678 | 廢鐵 | 500 | kg | 8.0 | 應付 |
```

- 同一趟車收多個品項 → 多行，相同日期+客戶+司機+車牌
- 簽約客戶的單價和費用方向可留空 → 系統自動帶入合約價

---

## 8. 報表輸出格式

### 客戶月結明細 PDF

```
┌──────────────────────────────────────────────┐
│  [公司LOGO]  XX環保資源回收有限公司              │
│                                              │
│  客戶名稱：大明企業        結算月份：2026年1月   │
│  合約編號：C-2026-001                         │
├──────────────────────────────────────────────┤
│                                              │
│  收運明細                                     │
│  日期    │品項  │數量│單位│單價│費用方向│金額   │
│  01/05  │廢紙  │200│kg │3.5│ 應付  │  700  │
│  01/05  │廢塑膠│100│kg │2.0│ 應收  │  200  │
│  01/12  │廢紙  │300│kg │3.5│ 應付  │1,050  │
│  ...                                        │
│                                              │
│  車趟費：5趟 × 500元 = 2,500                  │
│                                              │
│  ※ 只有應收或只有應付時，不顯示淨額             │
│  應收合計：    3,200                           │
│  應付合計：      700                           │
│  淨額：       2,500                           │
│  稅額(5%)：     125                           │
│  總額：       2,625                           │
│                                              │
│  → 客戶應付我方 2,625 元                       │
│                                              │
│  匯款帳戶：台北富邦 012-xxxxx                   │
├──────────────────────────────────────────────┤
│  製表日期：2026/02/05                          │
└──────────────────────────────────────────────┘
```

### 站區彙總報表 Excel

#### 工作表一：客戶總額

```
XX站區 - 2026年1月 客戶彙總

| 客戶名稱 | 類型 | 應收 | 應付 | 車趟費 | 淨額 | 稅額 | 總額 |
|---------|------|------|------|-------|------|------|------|
| 大明企業 | 簽約 | 3,200| 700 | 2,500 |2,500 | 125 |2,625 |
| 小華工廠 | 簽約 | 8,000| 0   | 1,600 |8,000 | 400 |8,400 |
| 王先生   | 臨時 | 500  | 0   | 500   | 500  | 25  | 525  |
|---------|------|------|------|-------|------|------|------|
| 合計     |     |11,700| 700 | 4,600 |11,000| 550 |11,550|
```

#### 工作表二：品項彙總

```
XX站區 - 2026年1月 品項彙總

| 編號 | 品項 | 單位 | 總數量 | 應收金額 | 應付金額 | 淨額 |
|------|------|------|-------|---------|---------|------|
| 1   | 廢紙  | kg  | 5,000 | 0       | 17,500  |-17,500|
| 2   | 廢塑膠| kg  | 2,000 | 4,000   | 0       | 4,000|
| 3   | 廢鐵  | kg  | 3,000 | 0       | 24,000  |-24,000|
| 5   | 木棧板| 件  | 50    | 2,500   | 0       | 2,500|
|------|------|------|-------|---------|---------|------|
| 合計  |     |      |       | 6,500   | 41,500  |-35,000|
```

---

## 9. UI 佈局

### 整體佈局

```
┌─────────────────────────────────────────────────────┐
│  LOGO   回收業務自動化系統          [通知🔔] [使用者▼] │
├────────────┬────────────────────────────────────────┤
│            │                                        │
│  儀表板    │         主要內容區                      │
│            │                                        │
│  基礎資料 ▼ │                                        │
│  • 站區管理 │                                        │
│  • 品項管理 │                                        │
│  • 客戶管理 │                                        │
│  • 合約管理 │                                        │
│            │                                        │
│  營運管理 ▼ │                                        │
│  • 車趟管理 │                                        │
│  • Excel匯入│                                        │
│            │                                        │
│  帳務管理 ▼ │                                        │
│  • 月結管理 │                                        │
│  • 報表     │                                        │
│            │                                        │
│  系統 ▼    │                                        │
│  • 使用者   │                                        │
│  • 假日設定 │                                        │
│  • 排程管理 │                                        │
│            │                                        │
└────────────┴────────────────────────────────────────┘
```

### 儀表板頁面

```
┌─────────────────────────────────────────────────────┐
│  儀表板                              2026年2月       │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │ 本月車趟  │ │ 應收總額  │ │ 應付總額  │ │ 客戶數 │ │
│  │    42    │ │  85,000  │ │  32,000  │ │  156  │ │
│  └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│                                                     │
│  待處理事項                                          │
│  ┌─────────────────────────────────────────────┐    │
│  │ 待審核明細          12 筆    [前往審核]       │    │
│  │ 合約即將到期(30天內)  3 筆    [前往查看]       │    │
│  │ 寄送失敗待重試        2 筆    [前往處理]       │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
│  合約到期提醒                                        │
│  ┌─────────────────────────────────────────────┐    │
│  │ 客戶名稱  │合約編號    │到期日    │剩餘天數   │    │
│  │ 大明企業  │C-2026-001│2026/03/01│ 19天     │    │
│  │ 小華工廠  │C-2026-005│2026/02/28│ 18天     │    │
│  │ 李氏公司  │C-2026-012│2026/03/15│ 33天     │    │
│  └─────────────────────────────────────────────┘    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

### 客戶管理頁面

```
┌──────────────────────────────────────────────────┐
│  客戶管理                        [+ 新增客戶]     │
├──────────────────────────────────────────────────┤
│  [搜尋客戶名稱...]  站區[▼全部]  類型[▼全部]      │
├──────────────────────────────────────────────────┤
│  客戶名稱    │站區│類型 │車趟費│明細  │付款  │操作   │
│─────────────┼───┼────┼────┼─────┼─────┼─────│
│  大明企業    │北區│簽約 │按次  │月結  │一次付│[編輯] │
│  小華工廠    │南區│簽約 │按月  │按趟  │按趟付│[編輯] │
│  臨時王先生  │北區│臨時 │按次  │按趟  │按趟付│[編輯] │
│  李氏公司    │北區│簽約 │按次  │月結  │按趟付│[編輯] │
└──────────────────────────────────────────────────┘
```

### 合約管理頁面（品項層級計費）

```
┌──────────────────────────────────────────────────┐
│  ← 大明企業 - 合約管理              [+ 新增合約]   │
├──────────────────────────────────────────────────┤
│  合約編號: C-2026-001                             │
│  期間: 2026/01/01 ~ 2026/12/31    狀態: ●有效     │
├──────────────────────────────────────────────────┤
│  合約品項                          [+ 新增品項]    │
│  ┌──────────────────────────────────────────────┐│
│  │編號│品項名稱  │單位│單價(元)│費用方向│操作  ││
│  │───┼────────┼───┼──────┼──────┼─────││
│  │ 1 │廢紙     │ kg │  3.5  │ 應付  │[編輯]││
│  │ 2 │廢鐵     │ kg │  8.0  │ 應付  │[編輯]││
│  │ 3 │廢塑膠   │ kg │  2.0  │ 應收  │[編輯]││
│  │ 4 │廢棄物處理│ kg │ 15.0  │ 應收  │[編輯]││
│  │ 5 │木棧板   │ 件 │ 50.0  │ 應收  │[編輯]││
│  └──────────────────────────────────────────────┘│
└──────────────────────────────────────────────────┘
```

### 月結管理頁面

```
┌──────────────────────────────────────────────────────┐
│  月結管理  2026年1月          [▼選擇月份] [重新產出]   │
├──────────────────────────────────────────────────────┤
│  待審核(12)  已審核(5)  已寄送(30)  退回(2)           │
├──────────────────────────────────────────────────────┤
│  客戶名稱  │站區│應收    │應付    │淨額     │狀態│操作│
│───────────┼───┼───────┼───────┼────────┼───┼───│
│  大明企業  │北區│ 1,200 │ 3,500 │-2,300付│草稿│[審]│
│  小華工廠  │南區│ 8,000 │     0 │ 8,000收│草稿│[審]│
│───────────┴───┴───────┴───────┴────────┴───┴───│
│                               [全部審核通過] [匯出]  │
└──────────────────────────────────────────────────────┘

審核詳情展開：
┌──────────────────────────────────────────────────┐
│  大明企業 - 2026年1月明細                          │
│                                                  │
│  品項明細                                         │
│  日期    │品項    │數量│單位│單價 │方向│金額        │
│  01/05  │廢紙    │ 200│ kg │3.5 │應付│  -700      │
│  01/05  │廢塑膠  │ 100│ kg │2.0 │應收│  +200      │
│  01/12  │廢紙    │ 300│ kg │3.5 │應付│ -1,050     │
│  ...                                             │
│                                                  │
│  車趟費：5趟 × 500元 = +2,500（應收）              │
│                                                  │
│  彙總：應收 1,200 - 應付 3,500 = 淨額 -2,300      │
│  小計：2,300  稅額(5%)：115  總額：2,415           │
│       → 我方需付客戶 2,415 元                      │
│                                                  │
│           [退回修正]  [審核通過]                    │
└──────────────────────────────────────────────────┘
```

---

## 10. 修改檔案清單

全部重寫，以下為完整檔案結構：

### 後端

| 檔案路徑 | 說明 |
|---------|------|
| `backend/prisma/schema.prisma` | 重寫資料模型 |
| `backend/prisma/seed.ts` | 重寫種子資料 |
| `backend/src/index.ts` | 入口點 |
| `backend/src/app.ts` | Express 設定 |
| `backend/src/routes/auth.ts` | 認證 API |
| `backend/src/routes/sites.ts` | 站區 CRUD |
| `backend/src/routes/items.ts` | 品項 CRUD |
| `backend/src/routes/customers.ts` | 客戶 CRUD |
| `backend/src/routes/contracts.ts` | 合約 + 合約品項 CRUD |
| `backend/src/routes/trips.ts` | 車趟 + 趟次品項 CRUD |
| `backend/src/routes/import.ts` | Excel 匯入 |
| `backend/src/routes/statements.ts` | 月結明細 + 審核 + 寄送 |
| `backend/src/routes/reports.ts` | 報表產出 |
| `backend/src/routes/schedule.ts` | 排程管理 |
| `backend/src/routes/users.ts` | 使用者管理 |
| `backend/src/routes/holidays.ts` | 假日管理 |
| `backend/src/services/billing.service.ts` | 計費引擎 |
| `backend/src/services/statement.service.ts` | 月結明細產出 |
| `backend/src/services/pdf-generator.ts` | PDF 產出 |
| `backend/src/services/notification.service.ts` | Email 寄送（LINE 預留接口） |
| `backend/src/services/scheduler.service.ts` | 排程服務 |
| `backend/src/services/holiday.service.ts` | 假日判斷 |
| `backend/src/middleware/auth.ts` | JWT 驗證中介層 |

### 前端

| 檔案路徑 | 說明 |
|---------|------|
| `frontend/src/App.tsx` | 路由設定 |
| `frontend/src/components/AppLayout.tsx` | 側邊欄 + 頂部欄佈局 |
| `frontend/src/pages/LoginPage.tsx` | 登入頁 |
| `frontend/src/pages/DashboardPage.tsx` | 儀表板 |
| `frontend/src/pages/SitesPage.tsx` | 站區管理 |
| `frontend/src/pages/ItemsPage.tsx` | 品項管理 |
| `frontend/src/pages/CustomersPage.tsx` | 客戶管理 |
| `frontend/src/pages/ContractsPage.tsx` | 合約管理 + 合約品項 |
| `frontend/src/pages/TripsPage.tsx` | 車趟管理 + 品項明細 |
| `frontend/src/pages/ImportPage.tsx` | Excel 匯入 |
| `frontend/src/pages/StatementsPage.tsx` | 月結管理 + 審核 |
| `frontend/src/pages/ReportsPage.tsx` | 報表 |
| `frontend/src/pages/HolidaysPage.tsx` | 假日設定 |
| `frontend/src/pages/SchedulePage.tsx` | 排程管理 |
| `frontend/src/pages/UsersPage.tsx` | 使用者管理 |

### API 路由總覽

| 模組 | 路由 | 方法 | 說明 |
|------|------|------|------|
| 認證 | /api/auth/login | POST | 登入 |
| 認證 | /api/auth/me | GET | 取得當前使用者 |
| 站區 | /api/sites | GET/POST | 列表 / 新增 |
| 站區 | /api/sites/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 品項 | /api/items | GET/POST | 列表 / 新增 |
| 品項 | /api/items/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 客戶 | /api/customers | GET/POST | 列表 / 新增 |
| 客戶 | /api/customers/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 合約 | /api/contracts | GET/POST | 列表 / 新增 |
| 合約 | /api/contracts/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 合約品項 | /api/contracts/:id/items | GET/POST | 列表 / 新增 |
| 合約品項 | /api/contracts/:cid/items/:iid | PATCH/DELETE | 更新 / 刪除 |
| 車趟 | /api/trips | GET/POST | 列表 / 新增 |
| 車趟 | /api/trips/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |
| 車趟品項 | /api/trips/:id/items | GET/POST | 列表 / 新增 |
| 車趟品項 | /api/trips/:tid/items/:iid | PATCH/DELETE | 更新 / 刪除 |
| 匯入 | /api/import/trips | POST | Excel 批次匯入 |
| 月結 | /api/statements | GET | 月結明細列表 |
| 月結 | /api/statements/generate | POST | 手動觸發產出 |
| 月結 | /api/statements/:id | GET | 明細詳情 |
| 月結 | /api/statements/:id/review | PATCH | 審核（通過/退回） |
| 月結 | /api/statements/:id/send | POST | 寄送 |
| 報表 | /api/reports/customer/:id | GET | 客戶明細 PDF |
| 報表 | /api/reports/site/:id | GET | 站區彙總 Excel |
| 排程 | /api/schedule | GET | 排程狀態 |
| 排程 | /api/schedule/:name/trigger | POST | 手動觸發 |
| 假日 | /api/holidays | GET/POST | 列表 / 新增 |
| 假日 | /api/holidays/:id | DELETE | 刪除 |
| 假日 | /api/holidays/import | POST | 批次匯入 |
| 使用者 | /api/users | GET/POST | 列表 / 新增 |
| 使用者 | /api/users/:id | GET/PATCH/DELETE | 詳情 / 更新 / 刪除 |

---

## 11. 驗收標準

### 基礎資料
- [ ] 站區 CRUD 正常運作
- [ ] 品項主檔 CRUD 正常運作（編號流水號、名稱唯一、可設定單位）
- [ ] 客戶建立時可設定車趟費（收/不收、按次/按月、金額）
- [ ] 客戶建立時可設定明細產出方式（月結/按趟）和付款方式（一次付清/按趟分付）
- [ ] 客戶建立時可設定通知方式和匯款帳戶

### 合約與計費
- [ ] 合約 CRUD 正常運作（含期限管理）
- [ ] 合約品項可個別設定單價與費用方向（應收/應付/免費）
- [ ] 同一客戶不同品項可有不同費用方向

### 車趟與品項
- [ ] 車趟紀錄 CRUD 正常運作
- [ ] 簽約客戶建立車趟品項時，自動帶入合約價格和方向快照
- [ ] 臨時客戶建立車趟品項時，可手動輸入報價和方向
- [ ] Excel 批次匯入車趟 + 品項正常運作

### 月結流程
- [ ] 計費引擎正確計算應收/應付/車趟費/淨額/小計/稅額(5%)/總額
- [ ] 開票方式支援淨額一張和應收應付分開兩種模式
- [ ] 月結明細自動產出（5 號，遇假日提前至前一工作日）
- [ ] 審核流程正常（草稿→審核通過/退回→重新提交）
- [ ] 已審核明細自動寄送 Email（15 號，遇假日提前）
- [ ] 按趟明細客戶可獨立產出單趟明細
- [ ] 月結明細 + 按趟分次付款的客戶，明細整月一份但付款拆趟次

### 報表
- [ ] 客戶月結明細 PDF 正確產出（只有應收或應付時不顯示淨額）
- [ ] 站區彙總報表 Excel 正確產出（客戶總額 + 品項彙總兩個工作表）
- [ ] 不需開發票的客戶也能產出明細

### 系統管理
- [ ] 國定假日管理（新增/刪除/批次匯入）
- [ ] 假日調整邏輯正確（週六日 + 國定假日往前推）
- [ ] 合約到期提醒（30/15/7 天）
- [ ] 通知重試（寄送失敗自動重試）
- [ ] 排程可查看狀態和手動觸發

---

## 12. MVP 不做清單（未來擴充）

| 項目 | 預計時機 |
|------|---------|
| 權限分離（總部/站區） | 穩定運作後 |
| LINE 通知 | 申請 Bot 後 |
| 車機系統接入 | 確認 API 規格後 |
| ERP 接入 | 確認 API 規格後 |
| 報價審核流程 | 需求明確後 |
| 車趟排程預排 | 需求明確後 |
| 政府假日 API 自動更新 | 找到穩定資料源後 |
| 月結全自動（跳過審核） | 計算正確性確認後 |
