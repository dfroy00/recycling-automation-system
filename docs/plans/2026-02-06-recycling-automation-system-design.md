# 環保回收業務自動化系統設計文檔

**版本**: 1.0  
**日期**: 2026-02-06  
**狀態**: 設計完成，待實施

---

## 目錄

1. [業務背景](#業務背景)
2. [系統架構](#系統架構)
3. [資料流程與計費邏輯](#資料流程與計費邏輯)
4. [自動化排程](#自動化排程)
5. [資料庫設計](#資料庫設計)
6. [異常處理與風險控管](#異常處理與風險控管)
7. [網頁系統功能](#網頁系統功能)
8. [技術架構](#技術架構)
9. [實施步驟](#實施步驟)
10. [成本與效益](#成本與效益)

---

## 業務背景

### 公司概況
- 環保資源回收公司
- 目前營運7個站點（未來可能增減）
- 每個站點服務多個客戶（預估每站點約50客戶）

### 現有流程
1. 司機向客戶收取資源回收物，紙本記錄品項和重量
2. 辦公室人員將紙本資料輸入進銷存/ERP系統
3. 車機系統記錄車趟資料（日期、時間、司機、車牌）
4. 每月30號需產生客戶明細報表並發送
5. 每月15號需開立發票

### 業務需求
**四種客戶計費模式：**

- **A類**: 支付回收物費用（單價×重量）+ 車趟費用
- **B類**: 僅收取車趟費用（不支付回收物費用）
- **C類**: 有合約客戶，合約品項用合約價，其他品項用牌價（不收車趟費）
- **D類**: 無合約客戶，全部按牌價計費（不收車趟費）

### 痛點分析
- 人工整理資料耗時（每月約50小時）
- 計算錯誤率高（2-5%）
- 資料分散在多個系統（車機、ERP、客戶管理）
- 明細報表製作費時
- 通知發送需人工逐一處理
- 合約到期容易疏漏

---

## 系統架構

### 整體架構（三層設計）

```
┌─────────────────────────────────────────────────────────────┐
│                     資料收集層                                │
├─────────────────────────────────────────────────────────────┤
│  車機系統（每日自動匯出Excel）                                 │
│  進銷存/ERP系統（每日自動匯出品項重量Excel）                    │
│  共享資料夾 → 檔案監控服務（每小時自動匯入）                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   核心處理層（網頁系統）                        │
├─────────────────────────────────────────────────────────────┤
│  ・站點管理                    ・客戶資料管理                   │
│  ・品項單價設定                ・合約管理                       │
│  ・費用計算引擎                ・報表產生器                     │
│  ・異常偵測與警示              ・管理員預覽機制                 │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      通知發送層                               │
├─────────────────────────────────────────────────────────────┤
│  LINE Messaging API  ←→  客戶（依偏好）                       │
│  Email SMTP服務      ←→  客戶（依偏好）                       │
│  管理員預覽通知      →   管理員（發送前12小時）                 │
└─────────────────────────────────────────────────────────────┘
```

### 系統特色
- **完全自動化**: 從資料收集到報表發送全自動
- **風險控管**: 發送前12小時預覽機制，管理員可暫停
- **異常警示**: 即時偵測資料異常並通知
- **彈性排程**: 自動處理月份天數差異和例假日調整
- **多站點管理**: 支援站點新增/停用，易於擴展

---

## 資料流程與計費邏輯

### 每日資料收集流程

```
每日作業流程：
09:00 - 司機開始收取回收物（紙本記錄）
     ↓
17:00 - 司機回報，辦公室人員輸入ERP
     ↓
18:00 - 車機系統自動匯出當日車趟到共享資料夾
     ↓
18:30 - ERP系統自動匯出當日品項重量到共享資料夾
     ↓
19:00 - 檔案監控服務自動讀取並匯入資料庫
     ↓
19:05 - 自動比對驗證（客戶編號、品項名稱等）
     ↓
19:10 - 若有異常，立即發送警示給管理員
```

### 四種客戶計費邏輯

#### A類客戶（回收物費用 + 車趟費）

**計算公式：**
```
回收物費用 = Σ(品項牌價 × 重量)
車趟費用 = 車趟次數 × 單次車趟費
總金額 = 回收物費用 + 車趟費用
```

**明細內容：**
- 日期、趟數、車趟費
- 品項明細表（品項名稱、重量、牌價、小計）
- 回收物費用小計
- 總金額

#### B類客戶（僅車趟費）

**計算公式：**
```
總金額 = 車趟次數 × 單次車趟費
```

**明細內容：**
- 日期、趟數、車趟費
- 總金額
- **不顯示品項重量明細**

#### C類客戶（合約客戶，混合計價）

**計算公式：**
```
合約品項費用 = Σ(合約單價 × 重量)
非合約品項費用 = Σ(品項牌價 × 重量)
總金額 = 合約品項費用 + 非合約品項費用
（不收車趟費）
```

**明細內容：**
- 日期、趟數
- 品項明細表（品項名稱、重量、單價、小計）
  - 註明「合約價」或「牌價」
- 總金額

#### D類客戶（無合約，牌價計費）

**計算公式：**
```
總金額 = Σ(品項牌價 × 重量)
（不收車趟費）
```

**明細內容：**
- 日期、趟數
- 品項明細表（品項名稱、重量、牌價、小計）
- 總金額

### 資料驗證機制

**匯入時自動檢查：**
1. 客戶編號是否存在於客戶主檔
2. 品項名稱是否存在於單價表
3. 重量數值是否合理（0-10000公斤）
4. 車趟是否有對應的品項收取記錄（B類除外）
5. C類客戶合約是否過期

**異常處理：**
- 客戶編號不存在 → 標記「未知客戶」，暫存資料並通知管理員
- 品項不存在 → 暫存並通知管理員補建單價
- 重量異常 → 標記並要求人工確認
- 合約過期 → 自動改用牌價並通知管理員

---

## 自動化排程

### 每日自動作業

| 時間 | 作業內容 | 說明 |
|------|----------|------|
| 每小時整點 | 檔案監控與匯入 | 檢查共享資料夾，自動匯入新檔案 |
| 23:00 | 資料完整性檢查 | 檢查當日資料是否齊全 |
| 00:30 | 產生每日報告 | 匯入成功/異常筆數統計 |
| 10:00 | 合約到期檢查 | 掃描C類客戶合約到期日 |

### 每月月結作業（30號流程）

```
30號 09:00
└─ 系統自動計算當月所有客戶費用
└─ 產生月結明細報表（PDF）
   ↓
30號 10:00
└─ 發送預覽報表給管理員
└─ 標示異常金額（與上月差異>30%）
   ↓
30號 10:00 - 22:00（12小時緩衝期）
└─ 管理員檢查預覽
└─ 若有問題可點選「暫停發送」
└─ 可手動修正資料後再觸發發送
   ↓
30號 22:00
└─ 若未暫停，自動發送明細給客戶
└─ 依客戶偏好使用LINE或Email
   ↓
次日 09:00
└─ 發送成功/失敗報告給管理員
└─ 列出發送失敗的客戶清單
```

### 每月發票作業（15號流程）

```
15號 09:00
└─ 產生上月發票明細彙總表（Excel）
└─ 每個客戶一個分頁
   ↓
15號 10:00
└─ Email發送給管理員和財務人員
└─ 同時發送發票通知給客戶
   ↓
財務人員手動開立紙本發票
```

### 合約到期提醒機制

**每日10:00自動檢查：**

| 時間點 | 動作 | 通知對象 |
|--------|------|----------|
| 到期前30天 | 第一次提醒 | 管理員 + 業務人員 |
| 到期前15天 | 第二次提醒 | 管理員 + 業務人員 |
| 到期前7天 | 最後提醒（標示緊急） | 管理員 + 業務人員 |
| 到期當日 | 自動切換為牌價計費 | 管理員 + 業務人員 + 財務 |

**提醒內容包含：**
- 客戶名稱、站點
- 合約到期日
- 合約品項清單
- 快速連結到合約管理頁面

### 彈性排程邏輯

**月份天數調整：**
- 若當月只有28/29/30天，次日報告自動改為當月最後一天執行

**例假日調整：**
- 若30號或15號遇到六日或國定假日，自動提前到最近的工作日
- 範例：15號遇到週日 → 提前到13號（週五）執行全部流程

---

## 資料庫設計

### ER圖概念

```
站點 (sites) 1 ─────── N 客戶 (customers)
                            │
                            │ 1
                            │
                            │ N
                        車趟記錄 (trips)
                        品項收取記錄 (items_collected)
                        月結明細 (monthly_statements)
                            │
                            │ N
                            │
                            │ 1
                        合約品項單價 (contract_prices)
```

### 資料表結構

#### 1. 站點主檔表 (sites)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| site_id | VARCHAR(20) | 站點編號 | PK |
| site_name | VARCHAR(100) | 站點名稱 | |
| manager | VARCHAR(50) | 負責人 | |
| contact_phone | VARCHAR(20) | 聯絡電話 | |
| contact_email | VARCHAR(100) | Email | |
| status | VARCHAR(10) | 狀態 | 啟用/停用 |
| created_at | TIMESTAMP | 建立時間 | |
| updated_at | TIMESTAMP | 更新時間 | |

#### 2. 客戶主檔表 (customers)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| customer_id | VARCHAR(20) | 客戶編號 | PK |
| site_id | VARCHAR(20) | 站點編號 | FK → sites |
| customer_name | VARCHAR(100) | 客戶名稱 | |
| billing_type | CHAR(1) | 計費類型 | A/B/C/D |
| trip_price | DECIMAL(10,2) | 單次車趟費用 | 適用A/B類 |
| notification_method | VARCHAR(10) | 通知方式 | LINE/Email/Both |
| line_id | VARCHAR(100) | LINE ID | |
| email | VARCHAR(100) | Email | |
| status | VARCHAR(10) | 狀態 | 啟用/停用 |
| created_at | TIMESTAMP | 建立時間 | |
| updated_at | TIMESTAMP | 更新時間 | |

**索引：**
- `idx_site_id` on `site_id`
- `idx_billing_type` on `billing_type`

#### 3. 合約品項單價表 (contract_prices)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| contract_price_id | SERIAL | 流水號 | PK |
| customer_id | VARCHAR(20) | 客戶編號 | FK → customers |
| item_name | VARCHAR(100) | 品項名稱 | |
| contract_price | DECIMAL(10,2) | 合約單價 | 元/公斤 |
| start_date | DATE | 合約起始日 | |
| end_date | DATE | 合約結束日 | |
| created_at | TIMESTAMP | 建立時間 | |

**索引：**
- `idx_customer_item` on `customer_id, item_name`
- `idx_end_date` on `end_date` (用於到期提醒查詢)

#### 4. 品項標準單價表 (item_prices)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| item_price_id | SERIAL | 流水號 | PK |
| item_name | VARCHAR(100) | 品項名稱 | |
| standard_price | DECIMAL(10,2) | 牌價 | 元/公斤 |
| effective_date | DATE | 生效日期 | |
| expiry_date | DATE | 失效日期 | NULL表示目前有效 |
| created_at | TIMESTAMP | 建立時間 | |

**索引：**
- `idx_item_effective` on `item_name, effective_date, expiry_date`

#### 5. 車趟記錄表 (trips)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| trip_id | SERIAL | 流水號 | PK |
| site_id | VARCHAR(20) | 站點編號 | FK → sites |
| customer_id | VARCHAR(20) | 客戶編號 | FK → customers |
| trip_date | DATE | 車趟日期 | |
| trip_time | TIME | 車趟時間 | |
| driver | VARCHAR(50) | 司機 | |
| vehicle_plate | VARCHAR(20) | 車牌 | |
| imported_at | TIMESTAMP | 匯入時間 | |
| source_file | VARCHAR(200) | 來源檔案名稱 | |

**索引：**
- `idx_customer_date` on `customer_id, trip_date`
- `idx_site_date` on `site_id, trip_date`

#### 6. 品項收取記錄表 (items_collected)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| collection_id | SERIAL | 流水號 | PK |
| site_id | VARCHAR(20) | 站點編號 | FK → sites |
| customer_id | VARCHAR(20) | 客戶編號 | FK → customers |
| collection_date | DATE | 收取日期 | |
| item_name | VARCHAR(100) | 品項名稱 | |
| weight_kg | DECIMAL(10,2) | 重量（公斤） | |
| imported_at | TIMESTAMP | 匯入時間 | |
| source_file | VARCHAR(200) | 來源檔案名稱 | |

**索引：**
- `idx_customer_date` on `customer_id, collection_date`
- `idx_item_date` on `item_name, collection_date`

#### 7. 月結明細表 (monthly_statements)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| statement_id | SERIAL | 流水號 | PK |
| site_id | VARCHAR(20) | 站點編號 | FK → sites |
| customer_id | VARCHAR(20) | 客戶編號 | FK → customers |
| year_month | VARCHAR(7) | 結算年月 | YYYY-MM |
| total_amount | DECIMAL(12,2) | 總金額 | |
| detail_json | JSONB | 明細內容 | JSON格式 |
| generated_at | TIMESTAMP | 產生時間 | |
| sent_at | TIMESTAMP | 發送時間 | |
| send_status | VARCHAR(20) | 發送狀態 | success/failed/pending |
| pdf_path | VARCHAR(200) | PDF檔案路徑 | |

**JSON結構範例 (detail_json)：**
```json
{
  "billing_type": "A",
  "trip_fee": 3000,
  "trip_count": 6,
  "items": [
    {"item": "紙類", "weight": 150.5, "price": 5.0, "subtotal": 752.5},
    {"item": "塑膠", "weight": 80.2, "price": 3.5, "subtotal": 280.7}
  ],
  "item_fee": 1033.2,
  "total": 4033.2,
  "anomaly": false
}
```

**索引：**
- `idx_year_month` on `year_month`
- `idx_send_status` on `send_status`

#### 8. 系統日誌表 (system_logs)

| 欄位名稱 | 資料型態 | 說明 | 備註 |
|---------|---------|------|------|
| log_id | SERIAL | 流水號 | PK |
| site_id | VARCHAR(20) | 站點編號 | 可為NULL |
| event_type | VARCHAR(50) | 事件類型 | import/calculate/send/error |
| event_content | TEXT | 事件內容 | |
| created_at | TIMESTAMP | 發生時間 | |

**索引：**
- `idx_event_time` on `event_type, created_at`

---

## 異常處理與風險控管

### 資料匯入異常偵測

#### 1. 檔案層級異常

| 異常情況 | 處理方式 | 通知對象 |
|---------|---------|---------|
| 檔案格式錯誤 | 記錄日誌，暫停匯入 | 管理員（即時Email） |
| 檔案欄位不符 | 記錄日誌，附上檔案路徑 | 管理員（即時Email） |
| 連續2天未更新 | 發送警示 | 管理員（Email+系統通知） |
| 重複匯入相同檔案 | 自動跳過，記錄日誌 | 僅記錄，不通知 |

#### 2. 資料內容異常

| 異常情況 | 處理方式 | 通知對象 |
|---------|---------|---------|
| 客戶編號不存在 | 標記「未知客戶」，暫存資料 | 管理員（每日彙整） |
| 品項名稱不在單價表 | 暫存資料，待補建單價 | 管理員（每日彙整） |
| 重量數值異常 | 標記為異常，要求人工確認 | 管理員（每日彙整） |
| 車趟無對應品項 | 自動判斷是否為B類客戶 | 若非B類則通知管理員 |

**重量異常判斷標準：**
- 負數
- 超過10,000公斤
- 同一客戶單次收取超過該品項歷史平均的3倍

#### 3. 計費金額異常

| 異常情況 | 處理方式 | 警示方式 |
|---------|---------|---------|
| 與上月差異>30% | 預覽時標示「異常」 | 在PDF明細加註警示 |
| 與去年同期差異>50% | 預覽時標示「重大異常」 | 紅字標示 |
| 總金額為0 | 不發送明細，僅記錄 | 日誌記錄 |
| C類合約過期 | 自動改用牌價 | 即時通知管理員+業務 |

### 合約管理與提醒

**自動提醒排程：**

```
每日 10:00 執行合約掃描
  ↓
查詢 end_date 在未來30天內的合約
  ↓
依到期天數分類
  ├─ 30天內：發送第一次提醒
  ├─ 15天內：發送第二次提醒
  ├─ 7天內：發送最後提醒（標示緊急）
  └─ 當日到期：自動切換為牌價
```

**提醒郵件範本：**
```
主旨：【緊急】客戶合約即將到期 - {客戶名稱}

{管理員} 您好：

以下客戶合約即將於 {到期日} 到期，請儘速處理續約事宜。

客戶資訊：
- 客戶編號：{customer_id}
- 客戶名稱：{customer_name}
- 所屬站點：{site_name}
- 合約到期日：{end_date}
- 剩餘天數：{days_left} 天

合約品項：
{品項清單}

若未於到期前更新合約，系統將自動改用牌價計費。

快速連結：[前往合約管理]
```

### 通知發送失敗處理

**失敗重試機制：**

```
發送失敗
  ↓
檢查失敗原因
  ├─ LINE發送失敗
  │   └─ 若客戶有Email → 自動改用Email
  │   └─ 若無Email → 記錄失敗
  │
  └─ Email發送失敗
      └─ 記錄失敗原因
      └─ 次日 09:00 自動重試
      └─ 連續2次失敗 → 通知管理員人工處理
```

**失敗通知範本：**
```
主旨：客戶通知發送失敗報告 - {年月}

以下客戶的月結明細發送失敗，請人工處理：

失敗清單：
1. {客戶名稱} - LINE發送失敗（錯誤：用戶已封鎖）
2. {客戶名稱} - Email發送失敗（錯誤：信箱不存在）

請聯絡客戶更新通知管道，或手動發送明細。

[查看詳細失敗記錄]
```

### 管理員監控介面

**儀表板即時顯示：**
- 今日匯入筆數（車趟/品項）
- 異常筆數（紅字標示）
- 待處理警示數（可點選查看）
- 即將到期合約數（30天內）
- 本月已發送/待發送明細數

**異常處理工作流：**
1. 管理員登入查看異常清單
2. 點選異常項目查看詳細資訊
3. 可直接在頁面修正資料或補建設定
4. 修正後標記為「已處理」
5. 系統自動重新計算相關費用

---

## 網頁系統功能

### 系統角色與權限

| 角色 | 權限範圍 | 主要功能 |
|-----|---------|---------|
| **系統管理員** | 全部站點 | 站點管理、系統設定、全站報表 |
| **站點管理員** | 所屬站點 | 客戶管理、資料查詢、站點報表 |
| **財務人員** | 全部站點（唯讀） | 查看報表、接收發票明細 |
| **業務人員** | 相關客戶 | 客戶資料、合約管理、接收提醒 |

### 功能模組架構

```
主選單
├─ 儀表板
├─ 站點管理
│   └─ 站點清單
├─ 客戶管理
│   ├─ 客戶清單
│   ├─ 新增/編輯客戶
│   └─ 合約管理
├─ 品項管理
│   ├─ 標準單價表
│   └─ 價格歷史
├─ 資料管理
│   ├─ 手動匯入
│   ├─ 車趟記錄查詢
│   ├─ 品項收取查詢
│   └─ 資料修正
├─ 報表管理
│   ├─ 月結明細查詢
│   ├─ 發票明細查詢
│   └─ 營運報表
├─ 通知管理
│   ├─ 發送記錄
│   ├─ 手動重發
│   └─ 通知測試
└─ 系統設定
    ├─ 排程設定
    ├─ 通知範本
    ├─ 使用者管理
    └─ 系統日誌
```

### 主要頁面設計

#### 1. 儀表板 (Dashboard)

**上方卡片區：**
- 今日匯入筆數（車趟 / 品項）
- 本月車趟總數
- 本月營收預估
- 異常警示數（紅色標示，可點選）

**即將到期合約列表：**
- 表格顯示：客戶名稱、站點、到期日、剩餘天數
- 顏色標示：7天內紅色、15天內橙色、30天內黃色

**異常項目列表：**
- 未處理的資料異常、計費異常
- 可直接點選處理

**快速操作按鈕：**
- 手動匯入檔案
- 重新計算費用
- 產生報表
- 發送測試通知

#### 2. 客戶管理

**客戶清單頁：**
- 篩選條件：站點、計費類型、狀態
- 搜尋：客戶編號、客戶名稱
- 表格欄位：客戶編號、名稱、站點、計費類型、車趟費、通知方式、狀態
- 操作：編輯、查看明細、設定合約

**新增/編輯客戶頁：**
- 基本資料區：編號、名稱、站點
- 計費設定區：計費類型（A/B/C/D）、車趟單價
- 通知設定區：通知方式（LINE/Email/Both）、LINE ID、Email
- 狀態：啟用/停用

**合約管理頁（C類客戶）：**
- 表格顯示：品項名稱、合約單價、起始日、結束日
- 操作：新增品項、編輯單價、延長合約
- 批次匯入：可上傳Excel批次設定合約品項

#### 3. 品項管理

**標準單價表：**
- 表格顯示：品項名稱、牌價、生效日期
- 操作：新增品項、調整單價
- 價格調整：輸入新單價和生效日期，系統自動保留歷史價格

**價格歷史：**
- 可查詢任一品項的歷史價格變動
- 圖表顯示價格趨勢

#### 4. 資料管理

**手動匯入：**
- 上傳車機Excel檔案
- 上傳ERP品項重量Excel檔案
- 匯入前預覽資料
- 匯入後顯示成功/失敗筆數

**車趟記錄查詢：**
- 篩選：日期區間、站點、客戶、司機
- 表格顯示：日期、時間、客戶、司機、車牌
- 匯出Excel

**品項收取查詢：**
- 篩選：日期區間、站點、客戶、品項
- 表格顯示：日期、客戶、品項、重量
- 統計：總重量、平均重量
- 匯出Excel

**資料修正：**
- 查詢異常資料
- 直接修正重量、品項、客戶編號
- 修正後自動重新計算相關費用

#### 5. 報表管理

**月結明細查詢：**
- 篩選：年月、站點、客戶
- 表格顯示：客戶、總金額、發送狀態、發送時間
- 操作：下載PDF、重新發送、查看詳細內容

**發票明細查詢：**
- 篩選：年月、站點
- 下載Excel彙總表
- 查看各客戶發票金額

**營運報表：**
- 各站點營收統計（月度/年度）
- 客戶營收排行
- 品項收取統計
- 司機車趟統計
- 圖表視覺化

#### 6. 通知管理

**發送記錄：**
- 篩選：日期、客戶、發送方式、狀態
- 表格顯示：發送時間、客戶、方式（LINE/Email）、狀態、失敗原因
- 操作：重新發送

**通知測試：**
- 發送測試LINE訊息
- 發送測試Email
- 驗證LINE/Email設定是否正確

#### 7. 系統設定

**排程設定：**
- 調整30號、15號執行時間
- 設定預覽緩衝時間（預設12小時）
- 設定檔案監控頻率（預設每小時）

**通知範本編輯：**
- LINE訊息範本
- Email主旨和內文範本
- 支援變數替換（如{客戶名稱}、{總金額}等）

**使用者管理：**
- 新增/編輯使用者帳號
- 設定角色和權限
- 指派管理站點

**系統日誌：**
- 查詢所有系統操作記錄
- 篩選：日期、事件類型、使用者
- 匯出日誌

---

## 技術架構

### 技術選型

#### 前端技術堆疊
- **框架**: React 18 + TypeScript
- **UI框架**: Ant Design (antd) 5.x
- **狀態管理**: React Query（TanStack Query）
- **路由**: React Router v6
- **圖表**: Chart.js 或 Apache ECharts
- **表單驗證**: React Hook Form + Zod
- **HTTP客戶端**: Axios

#### 後端技術堆疊
- **執行環境**: Node.js 20 LTS
- **框架**: Express.js
- **語言**: TypeScript
- **資料庫**: PostgreSQL 16
- **ORM**: Prisma
- **排程**: node-cron
- **檔案處理**:
  - Excel讀取: exceljs
  - PDF產生: pdfkit
  - 檔案監控: chokidar
- **身份驗證**: JWT (jsonwebtoken)
- **密碼加密**: bcrypt
- **日誌**: winston

#### 整合服務
- **LINE**: @line/bot-sdk
- **Email**: nodemailer + Gmail SMTP

### 系統架構圖

```
┌─────────────────────────────────────────────────────────┐
│                      前端 (React)                        │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │
│  │儀表板   │  │客戶管理 │  │報表管理 │  │系統設定 │   │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘   │
│                         ↓                                │
│                  REST API (HTTPS)                        │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                   後端 (Express.js)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │  API路由     │  │  排程服務    │  │  檔案監控    │ │
│  │  (JWT驗證)   │  │  (node-cron) │  │  (chokidar)  │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│           ↓                ↓                 ↓           │
│  ┌───────────────────────────────────────────────────┐ │
│  │            業務邏輯層 (Services)                   │ │
│  │  - 計費引擎  - 報表產生  - 通知發送  - 異常偵測  │ │
│  └───────────────────────────────────────────────────┘ │
│           ↓                                              │
│  ┌───────────────────────────────────────────────────┐ │
│  │            資料存取層 (Prisma ORM)                 │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│                 PostgreSQL 資料庫                        │
└─────────────────────────────────────────────────────────┘
        ↓                          ↓
┌──────────────┐          ┌──────────────┐
│ 共享資料夾    │          │ 外部服務     │
│ (車機/ERP)    │          │ LINE / Email │
└──────────────┘          └──────────────┘
```

### 檔案處理流程（Worker Threads優化）

**避免阻塞主線程：**

```javascript
// 主線程 (API Server)
app.post('/api/import/manual', async (req, res) => {
  // 接收檔案上傳
  const filePath = req.file.path;
  
  // 啟動Worker Thread處理檔案
  const worker = new Worker('./workers/excel-parser.js', {
    workerData: { filePath }
  });
  
  // 立即回應使用者（不等待處理完成）
  res.json({ status: 'processing', jobId: worker.threadId });
  
  // 背景處理
  worker.on('message', (result) => {
    // 處理完成，儲存結果到資料庫
    saveImportResult(result);
  });
});

// Worker Thread (excel-parser.js)
const { parentPort, workerData } = require('worker_threads');
const ExcelJS = require('exceljs');

async function parseExcel(filePath) {
  const workbook = new ExcelJS.Workbook();
  await workbook.xlsx.readFile(filePath);
  
  // 分批處理，每1000筆發送一次
  const rows = [];
  worksheet.eachRow((row, rowNumber) => {
    rows.push(parseRow(row));
    if (rows.length === 1000) {
      parentPort.postMessage({ batch: rows });
      rows.length = 0;
    }
  });
  
  // 發送剩餘資料
  if (rows.length > 0) {
    parentPort.postMessage({ batch: rows });
  }
  
  parentPort.postMessage({ done: true });
}

parseExcel(workerData.filePath);
```

### 部署架構

#### 方案一：本地部署（建議）

**硬體需求：**
- CPU: 4核心以上
- RAM: 8GB以上
- 硬碟: 500GB以上（SSD優先）
- 作業系統: Windows Server 2019/2022

**軟體部署：**
```
Windows Server
  ├─ Docker Desktop
  │   ├─ PostgreSQL Container
  │   ├─ Backend API Container
  │   └─ Nginx Container (前端靜態檔案)
  │
  ├─ 共享資料夾掛載
  │   ├─ \\server\trips\ (車機匯出)
  │   └─ \\server\items\ (ERP匯出)
  │
  └─ 備份腳本 (每日自動備份資料庫)
```

**Docker Compose 配置：**
```yaml
version: '3.8'
services:
  postgres:
    image: postgres:16
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: recycle_db
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    ports:
      - "5432:5432"
  
  backend:
    build: ./backend
    volumes:
      - //server/trips:/app/data/trips
      - //server/items:/app/data/items
      - ./uploads:/app/uploads
    environment:
      DATABASE_URL: postgresql://postgres:${DB_PASSWORD}@postgres:5432/recycle_db
      LINE_CHANNEL_TOKEN: ${LINE_TOKEN}
      SMTP_HOST: smtp.gmail.com
    depends_on:
      - postgres
    ports:
      - "3000:3000"
  
  nginx:
    image: nginx:alpine
    volumes:
      - ./frontend/build:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - backend

volumes:
  pgdata:
```

#### 方案二：雲端部署（可選）

**AWS架構：**
- EC2: 執行後端服務
- RDS PostgreSQL: 資料庫
- S3: 儲存PDF報表
- CloudFront: CDN加速前端
- Lambda: 排程任務（可選）

**成本估算：**
- EC2 (t3.medium): ~$30/月
- RDS (db.t3.micro): ~$15/月
- S3 + CloudFront: ~$5/月
- **總計：約$50/月（約NT$1,500/月）**

### 安全性設計

**身份驗證：**
- JWT Token機制
- Token有效期：8小時
- Refresh Token機制
- 密碼強度要求：至少8字元、包含英數字

**資料加密：**
- HTTPS傳輸（TLS 1.3）
- 密碼使用bcrypt加密（cost factor: 12）
- 敏感資料（如LINE ID）加密儲存

**權限控管：**
- 基於角色的存取控制（RBAC）
- API路由層級權限檢查
- 資料庫層級Row-Level Security

**操作稽核：**
- 所有寫入操作記錄日誌
- 記錄內容：使用者、時間、操作內容、IP位址
- 日誌保留180天

**備份策略：**
- 每日自動備份資料庫（凌晨2:00）
- 保留30天備份
- 每週完整備份，保留3個月
- 備份檔案加密儲存

### 技術選型的缺陷與對策

#### 已知缺陷

**1. Node.js處理大型Excel效能問題**
- **風險**: 單月超過5000筆資料時可能阻塞
- **對策**: 使用Worker Threads分批處理

**2. PostgreSQL在Windows效能較差**
- **風險**: 資料量大時可能變慢
- **對策**: 使用Docker內的Linux容器

**3. JavaScript生態系統變動快**
- **風險**: 套件更新可能出現破壞性變更
- **對策**: 鎖定版本號，定期測試後才升級

**4. 需要全端技能**
- **風險**: 維護需要懂前後端
- **對策**: 完善文件、模組化設計、提供教育訓練

---

## 實施步驟

### 階段一：基礎建設（2-3週）

**Week 1-2: 環境建置**
- [ ] 安裝Windows Server（或準備現有伺服器）
- [ ] 安裝Docker Desktop
- [ ] 設定PostgreSQL容器
- [ ] 設定共享資料夾（車機/ERP匯出路徑）
- [ ] 安裝Node.js 20 LTS
- [ ] 設定開發環境（VSCode、Git）

**Week 2-3: 資料庫建立**
- [ ] 撰寫Prisma Schema
- [ ] 建立所有資料表
- [ ] 設定索引和外鍵
- [ ] 匯入基礎資料：
  - [ ] 7個站點資料
  - [ ] 現有客戶清單
  - [ ] 品項標準單價表
  - [ ] C類客戶合約資料

**Week 3: 身份驗證系統**
- [ ] 使用者註冊/登入API
- [ ] JWT Token產生與驗證
- [ ] 角色權限中介層
- [ ] 前端登入頁面

### 階段二：核心功能開發（4-5週）

**Week 4-5: 檔案匯入模組**
- [ ] 車機Excel解析器
- [ ] ERP Excel解析器
- [ ] 檔案格式驗證
- [ ] 資料內容驗證（客戶編號、品項名稱、重量）
- [ ] 異常偵測邏輯
- [ ] Worker Thread優化處理
- [ ] 檔案監控服務（chokidar）
- [ ] 異常通知Email發送

**Week 6-7: 計費引擎**
- [ ] A類客戶計費邏輯
- [ ] B類客戶計費邏輯
- [ ] C類客戶計費邏輯（合約+牌價混合）
- [ ] D類客戶計費邏輯
- [ ] 月結明細計算
- [ ] 金額異常偵測（與上月比較）
- [ ] 單元測試（各類客戶計費正確性）

**Week 7-8: 網頁管理介面**
- [ ] 儀表板頁面
- [ ] 站點管理（CRUD）
- [ ] 客戶管理（CRUD）
- [ ] 合約管理（C類客戶）
- [ ] 品項單價管理
- [ ] 資料查詢頁面（車趟/品項）
- [ ] 資料修正功能
- [ ] 手動匯入介面

### 階段三：報表與通知（3-4週）

**Week 9-10: PDF報表產生**
- [ ] 設計PDF範本（4種客戶類型）
- [ ] 使用pdfkit實作報表產生
- [ ] 公司Logo和格式美化
- [ ] 明細表格排版
- [ ] 異常金額標示（紅字）
- [ ] PDF儲存路徑管理

**Week 10-11: Excel發票明細**
- [ ] 使用exceljs產生Excel
- [ ] 每客戶一分頁
- [ ] 總表彙總（依站點分組）
- [ ] 格式美化（凍結首列、自動欄寬）

**Week 11-12: 通知發送**
- [ ] LINE Messaging API整合
- [ ] LINE Bot設定（Channel Token）
- [ ] 發送LINE訊息+PDF附件
- [ ] Email SMTP設定
- [ ] 發送Email+PDF附件
- [ ] 發送失敗重試邏輯
- [ ] 發送記錄儲存
- [ ] 管理員預覽Email

### 階段四：自動化排程（1-2週）

**Week 13: 排程任務**
- [ ] 使用node-cron設定排程
- [ ] 每小時檔案監控
- [ ] 每日23:00資料完整性檢查
- [ ] 每日10:00合約到期掃描
- [ ] 30號月結流程
- [ ] 15號發票流程
- [ ] 例假日自動調整邏輯
- [ ] 排程執行日誌

**Week 14: 合約提醒**
- [ ] 合約到期掃描邏輯
- [ ] 30天/15天/7天提醒Email
- [ ] 到期自動切換牌價
- [ ] 儀表板即將到期合約顯示

### 階段五：測試與上線（2-3週）

**Week 15: 功能測試**
- [ ] 匯入功能測試（正常/異常檔案）
- [ ] 計費邏輯測試（4種客戶類型）
- [ ] 報表產生測試
- [ ] 通知發送測試（LINE/Email）
- [ ] 權限控管測試
- [ ] 異常處理測試

**Week 16: 整合測試**
- [ ] 準備測試資料（至少2個月完整資料）
- [ ] 執行完整月結流程
- [ ] 執行完整發票流程
- [ ] 驗證計算正確性（與人工計算對比）
- [ ] 壓力測試（大量資料匯入）
- [ ] 發送測試（測試LINE/Email帳號）

**Week 17: 使用者訓練與上線**
- [ ] 撰寫使用者操作手冊
- [ ] 管理員操作教學（2-3小時）
- [ ] 站點管理員操作教學
- [ ] 平行運作1個月（新舊系統同步）
- [ ] 每週檢視比對差異
- [ ] 正式上線切換
- [ ] 上線後1週密集監控

### 階段六：上線後優化（持續）

**上線後第1個月：**
- [ ] 每日檢查系統日誌
- [ ] 收集使用者回饋
- [ ] 修正小問題
- [ ] 優化使用體驗

**上線後第2-3個月：**
- [ ] 功能優化
- [ ] 效能調校
- [ ] 新增使用者要求的功能
- [ ] 撰寫API文件

### 專案時程總覽

```
月份 1          月份 2          月份 3          月份 4
├─────────┼─────────┼─────────┼─────────┤
│ 基礎建設 │核心功能 │報表通知 │測試上線 │
│ (3週)   │ (5週)   │ (4週)   │ (3週)   │
└─────────┴─────────┴─────────┴─────────┘
                                    ↓
                              正式上線
                                    ↓
                              持續優化
```

**總時程：15-17週（約3.5-4個月）**

### 風險管理

**風險一：現有系統無法自動匯出**
- **機率**: 中
- **影響**: 高（無法實現完全自動化）
- **對策**: 
  - 先與車機/ERP廠商確認是否支援定時匯出
  - 若不支援，降級為「智能提醒上傳」方案
  - 預留2週緩衝時間調整架構

**風險二：資料格式不一致**
- **機率**: 高
- **影響**: 中（匯入失敗率高）
- **對策**:
  - 詳細分析現有Excel格式
  - 設計彈性的解析器（支援多種格式）
  - 提供格式標準化建議

**風險三：LINE API額度不足**
- **機率**: 低
- **影響**: 低（成本增加）
- **對策**:
  - 監控每月發送量
  - 超過免費額度後評估是否升級方案
  - 或改為優先使用Email

**風險四：使用者抗拒改變**
- **機率**: 中
- **影響**: 中（導入困難）
- **對策**:
  - 充分的使用者訓練
  - 平行運作期間建立信心
  - 強調時間節省和錯誤減少的好處

---

## 成本與效益

### 開發成本估算

#### 一次性成本

**人力成本（外包開發）：**
- 全端工程師（3.5-4個月）：NT$300,000 - 500,000
- 專案管理與需求確認：NT$50,000
- **小計：NT$350,000 - 550,000**

**或自行開發：**
- 全端工程師薪資（4個月）：依公司薪資結構
- 預估工時：500-600小時

**硬體成本（若需新購）：**
- Windows Server主機：NT$80,000 - 150,000
- 或使用現有伺服器：NT$0

**軟體授權：**
- Windows Server授權：約NT$30,000（若需購買）
- PostgreSQL: 免費
- Node.js: 免費
- 其他套件: 免費（開源）

**總一次性成本：NT$350,000 - 730,000**

#### 年度營運成本

**雲端服務（若採用）：**
- AWS/GCP: 約NT$18,000/年
- 或本地部署: NT$0（僅電費）

**通訊服務：**
- LINE Messaging API: 約NT$500/年（超過免費額度部分）
- Email (SendGrid免費版): NT$0
- 網域+SSL: NT$3,000/年

**維護成本：**
- 系統維護（外包）: NT$50,000/年
- 或內部IT人員維護: 依公司人力成本

**總年度成本：NT$21,500 - 71,500**

### 效益分析

#### 時間節省（每月）

| 作業項目 | 現況耗時 | 自動化後 | 節省 |
|---------|---------|---------|------|
| 整理車趟資料 | 4小時 | 0小時 | 4小時 |
| 整理品項資料 | 4小時 | 0小時 | 4小時 |
| 計算350個客戶費用 | 16小時 | 0.5小時（檢查預覽） | 15.5小時 |
| 製作350份明細報表 | 20小時 | 0小時 | 20小時 |
| 發送通知 | 6小時 | 0小時 | 6小時 |
| 合約管理追蹤 | 2小時 | 0小時 | 2小時 |
| **總計** | **52小時** | **0.5小時** | **51.5小時** |

**每月節省：51.5小時 ≈ 6.4個工作天**

#### 成本節省（每月）

假設人力成本每小時NT$300：
- 每月節省：51.5小時 × NT$300 = **NT$15,450**
- 每年節省：NT$15,450 × 12 = **NT$185,400**

#### 投資回收期

**最佳情況：**
- 初期投資：NT$350,000
- 年度節省：NT$185,400 - NT$21,500 = NT$163,900
- **回收期：2.1年**

**最差情況：**
- 初期投資：NT$730,000
- 年度節省：NT$185,400 - NT$71,500 = NT$113,900
- **回收期：6.4年**

**合理情況（採本地部署+外包開發）：**
- 初期投資：NT$400,000
- 年度節省：NT$185,400 - NT$21,500 = NT$163,900
- **回收期：2.4年**

### 無形效益

#### 1. 錯誤減少
- 人工計算錯誤率：2-5%
- 自動化後錯誤率：<0.1%
- **效益**：減少客戶爭議、補單作業、商譽維護

#### 2. 客戶滿意度提升
- 準時收到明細報表（30號、15號）
- 明細清楚透明，易於對帳
- 專業形象提升
- **效益**：客戶留存率提升、口碑推薦

#### 3. 管理決策支援
- 即時掌握各站點營收
- 品項收取趨勢分析
- 客戶貢獻度排行
- **效益**：數據驅動決策、優化營運策略

#### 4. 合約管理改善
- 不漏失續約機會
- 提前30天提醒
- **效益**：營收不流失、業務關係維護

#### 5. 擴展性
- 新增站點容易（僅需建立資料）
- 客戶數成長不增加人力成本
- **效益**：支持業務快速擴張

#### 6. 人力彈性運用
- 釋放51.5小時/月人力
- 可投入更高價值工作（如客戶開發、服務改善）
- **效益**：人力效益最大化

### 風險與成本控管

**降低成本的建議：**

1. **採用本地部署**（省雲端費用）
2. **優先使用Email通知**（省LINE費用）
3. **分階段實施**：
   - 第一階段：1-2個站點試點
   - 驗證成功後再全面推廣
   - 降低失敗風險

4. **自行維護**（若有IT人員）
   - 提供完善文件和教育訓練
   - 省下每年NT$50,000外包維護費

### 投資決策建議

**建議投資**，理由：

1. **回收期合理**：2-3年可回收成本
2. **長期效益顯著**：第3年起每年淨效益NT$16萬
3. **支持業務擴展**：7站點擴展到10+站點不增加人力
4. **提升競爭力**：自動化、數位化是產業趨勢
5. **風險可控**：採分階段實施，失敗損失有限

**投資優先順序：**
1. 核心功能（匯入、計費、報表）→ 必要
2. 通知自動化 → 高價值
3. 儀表板與分析 → 中價值
4. 進階功能（客戶自助查詢） → 低優先級

---

## 附錄

### A. Excel檔案格式範例

#### 車機系統匯出格式

| 日期 | 時間 | 客戶編號 | 司機 | 車牌 |
|------|------|---------|------|------|
| 2026-02-01 | 09:30 | C001 | 王小明 | ABC-1234 |
| 2026-02-01 | 14:20 | C002 | 李大華 | XYZ-5678 |

#### ERP系統匯出格式

| 日期 | 客戶編號 | 品項名稱 | 重量(kg) |
|------|---------|---------|----------|
| 2026-02-01 | C001 | 紙類 | 150.5 |
| 2026-02-01 | C001 | 塑膠 | 80.2 |
| 2026-02-01 | C002 | 金屬 | 200.0 |

### B. 月結明細PDF範例

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
            XX環保資源回收公司
         2026年2月 月結明細表
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

客戶資訊
  客戶名稱：ABC科技股份有限公司
  客戶編號：C001
  所屬站點：台北站
  結算月份：2026年2月

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

車趟明細
  日期         趟數    車趟費
  02/05         2      600元
  02/12         3      900元
  02/19         2      600元
  02/26         1      300元
  ─────────────────────────
  小計         8趟    2,400元

品項明細
  品項      重量(kg)   單價   小計
  紙類       450.5     5.0   2,252元
  塑膠       220.3     3.5     771元
  金屬       180.0     8.0   1,440元
  ─────────────────────────
  小計                      4,463元

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

費用總計
  車趟費用：                2,400元
  回收物費用：              4,463元
  ═══════════════════════════
  總金額：                  6,863元

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

備註：
  ・發票將於3月15日開立
  ・如有疑問請聯絡：02-1234-5678

產生時間：2026-03-01 10:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### C. 關鍵API端點

```
身份驗證
POST   /api/auth/login          登入
POST   /api/auth/refresh        刷新Token

站點管理
GET    /api/sites               取得站點清單
POST   /api/sites               新增站點
PUT    /api/sites/:id           更新站點
DELETE /api/sites/:id           刪除站點

客戶管理
GET    /api/customers           取得客戶清單
POST   /api/customers           新增客戶
PUT    /api/customers/:id       更新客戶
GET    /api/customers/:id/contracts  取得客戶合約

資料匯入
POST   /api/import/trips        匯入車趟資料
POST   /api/import/items        匯入品項資料
GET    /api/import/status       查詢匯入狀態

報表管理
GET    /api/reports/monthly     取得月結明細
GET    /api/reports/invoice     取得發票明細
POST   /api/reports/regenerate  重新產生報表

通知管理
POST   /api/notifications/send  發送通知
GET    /api/notifications/logs  查詢發送記錄
POST   /api/notifications/retry 重新發送
```

### D. 系統需求檢查清單

**上線前確認：**

硬體環境
- [ ] 伺服器CPU >= 4核心
- [ ] RAM >= 8GB
- [ ] 硬碟空間 >= 500GB
- [ ] 網路頻寬穩定

軟體環境
- [ ] Windows Server 2019+
- [ ] Docker Desktop已安裝
- [ ] PostgreSQL容器運行正常
- [ ] 共享資料夾可存取

車機/ERP系統
- [ ] 確認可自動匯出Excel
- [ ] 確認匯出路徑設定
- [ ] 確認檔案格式一致

LINE設定
- [ ] LINE Bot Channel已建立
- [ ] Channel Access Token已取得
- [ ] 客戶已加入LINE Bot好友

Email設定
- [ ] SMTP帳號已設定
- [ ] 測試發送成功
- [ ] 白名單設定（避免進垃圾信箱）

資料準備
- [ ] 站點資料已匯入
- [ ] 客戶資料已匯入（含通知偏好）
- [ ] 品項單價已建立
- [ ] C類客戶合約已建立
- [ ] 使用者帳號已建立

測試確認
- [ ] 4種客戶類型計費測試通過
- [ ] 報表產生測試通過
- [ ] LINE/Email發送測試通過
- [ ] 排程任務測試通過
- [ ] 異常處理測試通過

---

## 結論

本設計文檔詳細規劃了環保回收業務自動化系統，從業務需求分析、系統架構設計、技術選型、到實施步驟與成本效益評估。

**核心價值：**
1. **完全自動化**：每月節省51.5小時人力
2. **降低錯誤**：計算錯誤率從2-5%降至<0.1%
3. **提升服務**：準時發送明細，客戶滿意度提升
4. **數據驅動**：即時掌握營運數據，支援決策
5. **易於擴展**：支持站點和客戶數成長

**投資回報：**
- 初期投資：NT$35-55萬
- 年度效益：NT$16-18萬
- 回收期：2-3年
- 長期效益顯著

**下一步行動：**
1. 確認預算和時程
2. 選擇開發方式（外包/自行開發）
3. 與車機/ERP廠商確認自動匯出可行性
4. 啟動專案，進入實施階段

---

**文檔版本歷史：**
- v1.0 (2026-02-06): 初版設計完成
